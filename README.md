# pawerpoint-genAI

Chrome拡張機能で、AIを使ってパワーポイントを自動生成したり、既存のパワーポイントを解析してJSON出力する機能を提供します。

## 🆕 新機能：既存のパワポ読み込み機能

プレビューパネルに「**既存のパワポを読み込む**」ボタンが追加されました！

### できること
- 既存のPPTXファイルをアップロード
- スライドごとの要素（テキスト、図形、背景色など）を自動解析
- **スライド番号**の位置・スタイル・色を自動検出
- **固定画像/ロゴ**の位置とサイズを抽出
- テーマカラー、マスタースタイル、箇条書きの完全解析
- 表の罫線・マージン・スタイルの詳細抽出
- 線・矢印の種類・スタイルの完全対応
- JSON形式で詳細なスライド情報を出力
- JSONをコピーして、AIプロンプトとして利用可能

### 使い方
1. プレビューパネルの「**既存のパワポを読み込む**」ボタンをクリック
2. PPTXファイルをドラッグ&ドロップ、または「ファイルを選択」から選択
3. 解析が完了すると、スライドごとの情報が表示されます
4. スライドをドロップダウンから選択
5. 「JSONをコピー」ボタンでJSON情報をクリップボードにコピー
6. このJSONをAIに渡して、同様のスライドを生成できます

### 技術詳細
- **JSZip**: PPTXファイル（ZIPアーカイブ）の展開
- **XMLパース**: スライドXMLからテキスト、位置、サイズ、色などを抽出
- **テーマカラー解析**: スライドマスターからテーマカラーを自動取得し、lumMod/lumOffによる輝度変換にも対応
- **スライド番号検出**: レイアウトファイルから`<a:fld type="slidenum">`を検索し、位置・フォント・色を抽出
- **固定画像抽出**: レイアウトファイルから`userDrawn="1"`の画像を検出
- **マスタースタイル継承**: プレースホルダーのデフォルトスタイルを自動適用
- **箇条書き解析**: インデントレベル、マーカー種類（文字/番号）、フォントを完全抽出
- **表の完全対応**: セル結合、罫線スタイル（太さ・色・線種）、マージン、塗りつぶしを抽出
- **線・矢印対応**: 開始/終了矢印の種類、線種（実線/破線）、flipH補正に対応
- **JSON出力**: PptxGenJS形式に準拠したJSON構造で出力し、AIが読み取りやすい実装例付きプロンプトを生成

## 🆕 新機能：API経由ダウンロード

プレビューパネルに「**API経由でダウンロード**」ボタンが追加されました！

### できること
- AIが生成したpptxgenjsコードをサーバー側で実行
- サーバー側で生成されたPowerPointファイルを直接ダウンロード
- ブラウザの制限を回避した高速・安定的なPowerPoint生成
- APIキー認証による安全な通信

### 使い方
1. **APIキーの設定**
   - APIキーを取得し、chrome.storage.localに保存します
   - 拡張機能内の設定画面、またはコンソールから設定可能
   ```javascript
   // コンソールでの設定例
   chrome.storage.local.set({ pptx_api_key: 'your-api-key-here' });
   ```

2. **PowerPointの生成**
   - AIチャット画面でpptxgenjsコードを含む回答を生成
   - プレビューパネルに「**API経由でダウンロード**」ボタン（緑色）が表示されます
   - ボタンをクリックすると、API経由でPowerPointが生成・ダウンロードされます

### ローカルエクスポート vs API経由ダウンロード

| 機能 | ローカルエクスポート | API経由ダウンロード |
|------|---------------------|---------------------|
| **ボタン色** | 青色 | 緑色 |
| **実行環境** | ブラウザ内（サンドボックス） | サーバー側 |
| **速度** | 中程度 | 高速 |
| **安定性** | ブラウザ依存 | 高い |
| **認証** | 不要 | APIキー必要 |
| **オフライン** | 可能 | 不可 |

### セキュリティアーキテクチャ
- **TLS/HTTPS暗号化**: すべての通信はHTTPSで暗号化されます
- **APIキー認証**: SHA-256ハッシュ化されたAPIキーで認証
- **IPアドレス制限**: Rakuten INTRAネットワークからのみアクセス可能
- **コード検証**: 送信されたコードはAST解析で安全性を確認
- **監査ログ**: すべてのAPI呼び出しがログに記録されます

### 技術詳細
- **API URL**: `https://powerpoint-genai-test-854259963531.asia-northeast1.run.app`
- **Extension ID**: `mnfcpmjknacajphhdlepejbcbnkllccg`（固定）
- **通信方式**: REST API（POST /generate-pptx）
- **認証ヘッダー**: `X-API-Key: <your-api-key>`
- **レスポンス形式**: Base64エンコードされたPPTXファイル
- **ストレージ**: chrome.storage.local（APIキー保存用）

### トラブルシューティング

#### APIキーが設定されていません
- chrome.storage.localにAPIキーを保存してください
- キーの名前は `pptx_api_key` である必要があります

#### APIキーが無効です
- APIキーの形式を確認してください（64文字の16進数文字列）
- 管理者から正しいAPIキーを取得してください

#### ネットワークエラー
- インターネット接続を確認してください
- Rakuten INTRAネットワークに接続していることを確認してください
- ファイアウォールやプロキシの設定を確認してください

#### API経由でのダウンロードに失敗しました
- サーバーが稼働していることを確認してください
- コンソールログでエラー詳細を確認してください
- pptxgenjsコードが正しい形式であることを確認してください

### 前提条件
- **APIサーバー**: APIサーバーが稼働している必要があります
- **APIキー**: 有効なAPIキーが設定されている必要があります
- **ネットワーク**: Rakuten INTRAネットワークへの接続が必要です
- **ブラウザ**: Chrome 88以降（Manifest V3対応）

## サンドボックス実行環境の主な機能

- 指定した JavaScript スニペットから安全に pptxgenjs の API だけを実行します。
- `for` ループや `for...of`、`array[i]` 形式の配列参照を解釈できるようになりました。
- スニペット内で相対パスを指定すると、自動的に `chrome.runtime.getURL()` が適用され、拡張機能内の画像などを参照できます（既に `chrome-extension://` などのスキームを含むパスは変換されません）。
- 外部への通信や `chrome.*` API は許可されませんが、`chrome.runtime.getURL()` の呼び出しは拡張機能内リソースに限定して処理されます。
- 指定された SVG アイコンが存在しない場合は、代替の幾何学図形アイコンに自動的に差し替えられます。
- 計算用途として `SLIDE_W`/`SLIDE_H` 定数と等間隔配置用の `evenX()`・`evenY()`、2次元グリッド用の `gridXY()` をスニペット内で利用できます。
- `%` 演算子や `Math.floor` / `Math.ceil` / `Math.round` / `Math.abs` / `Math.min` / `Math.max` / `Math.pow` / `Math.sqrt` といった数値計算がサポートされました。
- 中央配置用の `centerX()`・`centerY()` も利用でき、簡単に左右・上下の中央に配置できます。
