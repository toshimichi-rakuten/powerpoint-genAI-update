toshimichi.suzuki@P86934 ãƒã‚šãƒ¯ãƒ›ã‚šä½œæˆAI % tree
.
â”œâ”€â”€ docs
â”‚Â Â  â”œâ”€â”€ 1.text
â”‚Â Â  â”œâ”€â”€ HTMLãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ.text
â”‚Â Â  â”œâ”€â”€ How to use PPTgenjs.txt
â”‚Â Â  â””â”€â”€ ãƒã‚šãƒ¯ãƒ›ã‚šãƒ•ã‚šãƒ­ãƒ³ãƒ•ã‚šãƒˆ.text
â”œâ”€â”€ images
â”‚Â Â  â”œâ”€â”€ Arrow.png
â”‚Â Â  â”œâ”€â”€ download.png
â”‚Â Â  â”œâ”€â”€ icon128.png
â”‚Â Â  â”œâ”€â”€ icon16.png
â”‚Â Â  â”œâ”€â”€ icon32.png
â”‚Â Â  â”œâ”€â”€ icon48.png
â”‚Â Â  â””â”€â”€ reload.png
â”œâ”€â”€ logo.png
â”œâ”€â”€ manifest.json
â”œâ”€â”€ other
â”‚Â Â  â”œâ”€â”€ jquery.min.js
â”‚Â Â  â”œâ”€â”€ jszip.min.js
â”‚Â Â  â””â”€â”€ pptxgen.bundle.js
â”œâ”€â”€ popup.html
â”œâ”€â”€ popup.js
â”œâ”€â”€ pptxjs
â”‚Â Â  â”œâ”€â”€ LICENSE
â”‚Â Â  â”œâ”€â”€ README.md
â”‚Â Â  â”œâ”€â”€ Sample_12.pptx
â”‚Â Â  â”œâ”€â”€ css
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ nv.d3.min.css
â”‚Â Â  â”‚Â Â  â””â”€â”€ pptxjs.css
â”‚Â Â  â”œâ”€â”€ filereader.js
â”‚Â Â  â”œâ”€â”€ index.html
â”‚Â Â  â””â”€â”€ js
â”‚Â Â      â”œâ”€â”€ d3.min.js
â”‚Â Â      â”œâ”€â”€ dingbat.js
â”‚Â Â      â”œâ”€â”€ divs2slides.js
â”‚Â Â      â”œâ”€â”€ divs2slides.min.js
â”‚Â Â      â”œâ”€â”€ filereader.js
â”‚Â Â      â”œâ”€â”€ jquery-1.11.3.min.js
â”‚Â Â      â”œâ”€â”€ jquery.fullscreen-min.js
â”‚Â Â      â”œâ”€â”€ jszip.min.js
â”‚Â Â      â”œâ”€â”€ nv.d3.min.js
â”‚Â Â      â”œâ”€â”€ pptxjs.js
â”‚Â Â      â””â”€â”€ pptxjs.min.js
â”œâ”€â”€ preview
â”‚Â Â  â”œâ”€â”€ jsonDetector.js
â”‚Â Â  â”œâ”€â”€ previewManager.js
â”‚Â Â  â”œâ”€â”€ slideGenerator.js
â”‚Â Â  â””â”€â”€ ui.js
â””â”€â”€ slideCreator.js



cat slideCreator.js jsonDetector.js previewManager.js slideGenerator.js ui.js popup.html popup.js manifest.json
/**
 * slideCreator.js
 * =====================================================================
 * JSONãƒ‡ãƒ¼ã‚¿ã‹ã‚‰PowerPointã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ã‚³ã‚¢ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
 *
 * ãƒ»PptxGenJSã‚’åˆ©ç”¨ã—ã€ã‚¹ãƒ©ã‚¤ãƒ‰ãƒã‚¹ã‚¿ãƒ¼ï¼ˆãƒ­ã‚´æŒ¿å…¥ï¼ã‚¹ãƒ©ã‚¤ãƒ‰ç•ªå·ï¼‰ã‚’å®šç¾©
 * ãƒ»ãƒ†ã‚­ã‚¹ãƒˆï¼ã‚¢ã‚¸ã‚§ãƒ³ãƒ€ï¼ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ãƒãƒ£ãƒ¼ãƒˆï¼ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³
 *   å„ç¨®ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å®Ÿè£…
 * ãƒ»ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ç”¨ã«ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’èª¿æ•´å¯èƒ½
 * ãƒ»ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒ©ã‚¤ãƒ‰ã‚µãƒ³ãƒ—ãƒ«ã‚’æä¾›
 *
 * ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆAPI:
 *   - createSlideByType(slide, data, pptx, isPopup)
 *   - defineMasterSlide(pptx, logoPath)
 *   - getDefaultSlides()
 *   - createSlidesFromJson(pptx, jsonData, isPopup)
 *
 * Usage:
 *   const pptx = new PptxGenJS();
 *   SlideCreator.defineMasterSlide(pptx, logoPath);
 *   SlideCreator.createSlidesFromJson(pptx, jsonString, false);
 */

const SlideCreator = (function() {
    // å®šæ•°å®šç¾©
    const LAYOUT_WIDTH = 13.33;
    const LAYOUT_HEIGHT = 7.5;
    const MASTER_SLIDE_TITLE = 'MASTER_SLIDE';
    
    // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã¨æ›¸ä½“ã®å®šæ•°
    const TITLE_FONT_SIZE = 24;
    const HEADING_FONT_SIZE = 18;
    const BODY_FONT_SIZE = 16;
    const DEFAULT_FONT_FACE = 'Rakuten Sans JP';
    
    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ç”¨ã®å®šæ•°ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã§ã¯å°‘ã—å¤§ãã‚ã®ãƒ•ã‚©ãƒ³ãƒˆã‚’ä½¿ç”¨ï¼‰
    const POPUP_TITLE_FONT_SIZE = 36;
    const POPUP_HEADING_FONT_SIZE = 20;
    const POPUP_BODY_FONT_SIZE = 16;
    
    // ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¿ã‚¤ãƒ—ã”ã¨ã®ã‚¹ãƒ©ã‚¤ãƒ‰ä½œæˆé–¢æ•°
    function createSlideByType(slide, data, pptx, isPopup = false) {
      // slidetype ã¾ãŸã¯ type ã‚’å–å¾—ï¼ˆslidetypeã‚’å„ªå…ˆï¼‰
      const slideType = data.slidetype || data.type || 'default';
      
      // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’æ±ºå®šï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‹ã©ã†ã‹ã§åˆ†å²ï¼‰
      const titleSize = isPopup ? POPUP_TITLE_FONT_SIZE : TITLE_FONT_SIZE;
      const headingSize = isPopup ? POPUP_HEADING_FONT_SIZE : HEADING_FONT_SIZE;
      const bodySize = isPopup ? POPUP_BODY_FONT_SIZE : BODY_FONT_SIZE;
      
      // åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ©ã‚¤ãƒ‰ã‚¿ã‚¤ãƒ—
      if (slideType === 'default') {
        createDefaultSlide(slide, data, titleSize, headingSize, bodySize);
      } else if (slideType === 'agenda') {
        createAgendaSlide(slide, data, titleSize, headingSize, bodySize);
      } else if (slideType === 'table') {
        createTableSlide(slide, data, titleSize, headingSize, bodySize);
      } else if (slideType === 'chart') {
        createChartSlide(slide, data, titleSize, headingSize, bodySize);
      } else if (slideType === 'custom_schedule') {
        createCustomScheduleSlide(slide, data, pptx);
      } else if (slideType === 'milestone') {
        createMilestoneSlide(slide, data, pptx);
      } else {
        // æœªçŸ¥ã®ã‚¿ã‚¤ãƒ—ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ä½¿ç”¨
        createDefaultSlide(slide, data, titleSize, headingSize, bodySize);
      }
    }
    
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒ©ã‚¤ãƒ‰ï¼ˆé€šå¸¸ãƒ†ã‚­ã‚¹ãƒˆï¼‰
    function createDefaultSlide(slide, data, titleSize, headingSize, bodySize) {
      // ã‚¿ã‚¤ãƒˆãƒ«
      if (data.title) {
        slide.addText(data.title, { 
          x: 0.37, y: 0.35, w: 12.60, h: 0.59, 
          fontSize: titleSize, 
          fontFace: DEFAULT_FONT_FACE 
        });
      }
      
      // è¦‹å‡ºã—
      if (data.heading) {
        slide.addText(data.heading, { 
          x: 0.37, y: 1.19, w: 12.60, h: 0.4, 
          fill: 'DDDDDD', 
          color: '000000', // é»’è‰²ãƒ†ã‚­ã‚¹ãƒˆ
          fontSize: headingSize, 
          fontFace: DEFAULT_FONT_FACE,
          align: 'left',
          valign: 'middle'
        });
      }
      
      // æœ¬æ–‡
      if (data.body) {
        const bodyText = Array.isArray(data.body) ? data.body.join('\n\n') : data.body;
        slide.addText(bodyText, { 
          x: 0.37, y: 2.02, w: 12.60, h: 3.0, 
          valign: 'top', 
          fontSize: bodySize, 
          fontFace: DEFAULT_FONT_FACE,
          bullet: false  // ç®‡æ¡æ›¸ããªã—
        });
      } else if (data.items) {
        const itemsText = Array.isArray(data.items) ? data.items.join('\n\n') : data.items;
        slide.addText(itemsText, { 
          x: 0.37, y: 2.02, w: 12.60, h: 3.0, 
          valign: 'top', 
          fontSize: bodySize, 
          fontFace: DEFAULT_FONT_FACE,
          bullet: false  // ç®‡æ¡æ›¸ããªã—
        });
      }
    }
    
    // ã‚¢ã‚¸ã‚§ãƒ³ãƒ€ã‚¹ãƒ©ã‚¤ãƒ‰ï¼ˆç®‡æ¡æ›¸ãï¼‰
    function createAgendaSlide(slide, data, titleSize, headingSize, bodySize) {
      // ã‚¿ã‚¤ãƒˆãƒ«
      if (data.title) {
        slide.addText(data.title, { 
          x: 0.37, y: 0.35, w: 12.60, h: 0.59, 
          fontSize: titleSize, 
          fontFace: DEFAULT_FONT_FACE,
          bold: true,
          color: '000000' // é»’è‰²ã®ã‚¿ã‚¤ãƒˆãƒ«
        });
      }
      
      // ç®‡æ¡æ›¸ã
      if (data.body) {
        const bodyItems = Array.isArray(data.body) ? data.body : [data.body];
        let yPos = 2.02;
        bodyItems.forEach((item, index) => {
          slide.addText(`${index + 1}. ${item}`, { 
            x: 0.37, y: yPos, w: 12.60, h: 0.5, 
            valign: 'top', 
            fontSize: bodySize + 2, 
            fontFace: DEFAULT_FONT_FACE
          });
          yPos += 0.6; // æ¬¡ã®é …ç›®ã®ä½ç½®
        });
      } else if (data.items) {
        const itemsArray = Array.isArray(data.items) ? data.items : data.items.split('\n');
        let yPos = 2.02;
        itemsArray.forEach((item, index) => {
          slide.addText(`${index + 1}. ${item}`, { 
            x: 0.37, y: yPos, w: 12.60, h: 0.5, 
            valign: 'top', 
            fontSize: bodySize + 2, 
            fontFace: DEFAULT_FONT_FACE
          });
          yPos += 0.6; // æ¬¡ã®é …ç›®ã®ä½ç½®
        });
      }
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ãƒ©ã‚¤ãƒ‰ï¼ˆè¡¨å½¢å¼ï¼‰
    function createTableSlide(slide, data, titleSize, headingSize, bodySize) {
      // ã‚¿ã‚¤ãƒˆãƒ«
      if (data.title) {
        slide.addText(data.title, { 
          x: 0.37, y: 0.35, w: 12.60, h: 0.59, 
          fontSize: titleSize, 
          fontFace: DEFAULT_FONT_FACE 
        });
      }
      
      // è¦‹å‡ºã—
      if (data.heading) {
        slide.addText(data.heading, { 
          x: 0.37, y: 1.19, w: 12.60, h: 0.4, 
          fill: 'DDDDDD', 
          color: '000000', // é»’è‰²ãƒ†ã‚­ã‚¹ãƒˆ
          fontSize: headingSize, 
          fontFace: DEFAULT_FONT_FACE,
          align: 'left',
          valign: 'middle'
        });
      }
      
      // ãƒ†ãƒ¼ãƒ–ãƒ«
      if (data.tableData && Array.isArray(data.tableData) && data.tableData.length > 0) {
        const tableOpts = {
          x: 0.37, y: 1.86, w: 12.60, h: 4.78,
          fontSize: bodySize, 
          fontFace: DEFAULT_FONT_FACE, 
          align: 'center', 
          valign: 'middle',
          border: { pt: 1, color: 'BFBFBF' },
          headerStyle: { fill: '404040', color: 'FFFFFF', bold: true }
        };
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚«ã‚¹ã‚¿ãƒ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°é©ç”¨
        if (data.tableOptions) {
          Object.assign(tableOpts, data.tableOptions);
        }
        
        slide.addTable(data.tableData, tableOpts);
      } else {
        // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        slide.addText('ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', { 
          x: 0.37, y: 1.86, w: 12.60, h: 1.0, 
          fontSize: bodySize, 
          fontFace: DEFAULT_FONT_FACE,
          color: 'FF0000',
          align: 'center',
          valign: 'middle'
        });
      }
    }


// ã‚°ãƒ©ãƒ•ã®ä½œæˆ
    function createChartSlide(slide, data, titleSize, headingSize, bodySize) {
      // 1. ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¿½åŠ 
      if (data.title) {
        slide.addText(data.title, { 
          x: 0.37,           // å·¦ã‹ã‚‰ã®ä½ç½®
          y: 0.35,           // ä¸Šã‹ã‚‰ã®ä½ç½®
          w: 12.60,          // å¹…
          h: 0.59,           // é«˜ã•
          fontSize: titleSize, 
          fontFace: DEFAULT_FONT_FACE 
        });
      }
    
      // 2. è¦‹å‡ºã—ã‚’è¿½åŠ 
      if (data.heading) {
        slide.addText(data.heading, { 
          x: 0.37,           // å·¦ã‹ã‚‰ã®ä½ç½®
          y: 1.19,           // ä¸Šã‹ã‚‰ã®ä½ç½®
          w: 12.60,          // å¹…
          h: 0.4,            // é«˜ã•
          fill: 'DDDDDD',    // èƒŒæ™¯è‰²ï¼ˆè–„ã„ã‚°ãƒ¬ãƒ¼ï¼‰
          color: '000000',   // ãƒ†ã‚­ã‚¹ãƒˆè‰²ï¼ˆé»’ï¼‰
          fontSize: headingSize, 
          fontFace: DEFAULT_FONT_FACE,
          align: 'left',     // å·¦æƒãˆ
          valign: 'middle'   // å‚ç›´ä¸­å¤®æƒãˆ
        });
      }
    
      // 3. ã‚°ãƒ©ãƒ•ã‚’è¿½åŠ ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
      if (data.chartData && Array.isArray(data.chartData) && data.chartData.length > 0) {
        try {
          // ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼ã¨ä¿®æ­£
          const validatedChartData = data.chartData.map(series => {
            // å¿…é ˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ç¢ºèª
            if (!series.name || !Array.isArray(series.values)) {
              return {
                name: series.name || 'ãƒ‡ãƒ¼ã‚¿ç³»åˆ—',
                labels: Array.isArray(series.labels) ? series.labels : [],
                values: Array.isArray(series.values) ? series.values : [0]
              };
            }
            
            // å€¤ã®æ¤œè¨¼ - ç„¡åŠ¹ãªå€¤ã‚’0ã«ç½®æ›
            const cleanValues = series.values.map(val => {
              return (typeof val === 'number' && !isNaN(val) && isFinite(val)) ? val : 0;
            });
            
            // ãƒ©ãƒ™ãƒ«ã®æ¤œè¨¼
            let cleanLabels = Array.isArray(series.labels) ? 
              series.labels.map(label => String(label || '')) : 
              cleanValues.map((_, i) => `é …ç›®${i+1}`);
            
            // ãƒ©ãƒ™ãƒ«ã¨å€¤ã®é•·ã•ã‚’ä¸€è‡´ã•ã›ã‚‹
            while (cleanLabels.length < cleanValues.length) {
              cleanLabels.push(`é …ç›®${cleanLabels.length+1}`);
            }
            while (cleanValues.length < cleanLabels.length) {
              cleanValues.push(0);
            }
            
            return {
              name: String(series.name),
              labels: cleanLabels,
              values: cleanValues
            };
          });
    
          // 3.1 åŸºæœ¬çš„ãªã‚°ãƒ©ãƒ•è¨­å®š
          let chartOpts = {
            // ä½ç½®ã¨ã‚µã‚¤ã‚º
            x: 0.37,           // å·¦ã‹ã‚‰ã®ä½ç½®
            y: 1.7,            // ä¸Šã‹ã‚‰ã®ä½ç½®
            w: 12.60,          // å¹…
            h: 5,              // é«˜ã•
            
            // ã‚¿ã‚¤ãƒˆãƒ«è¨­å®š
            title: data.chartTitle || '',  // ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆæŒ‡å®šãŒãªã‘ã‚Œã°ç©ºï¼‰
            showTitle: true,               // ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¡¨ç¤º
            titleColor: '363636',          // ã‚¿ã‚¤ãƒˆãƒ«ã®è‰²ï¼ˆæ¿ƒã„ã‚°ãƒ¬ãƒ¼ï¼‰
            titleFontSize: 14,             // ã‚¿ã‚¤ãƒˆãƒ«ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º
            
            // å‡¡ä¾‹è¨­å®š
            showLegend: data.showLegend !== undefined ? data.showLegend : true,  // å‡¡ä¾‹è¡¨ç¤ºï¼ˆæŒ‡å®šãŒãªã‘ã‚Œã°è¡¨ç¤ºï¼‰
            legendPos: 'b',                // å‡¡ä¾‹ã®ä½ç½®ï¼ˆä¸‹ï¼‰
            legendColor: '363636',         // å‡¡ä¾‹ã®è‰²ï¼ˆæ¿ƒã„ã‚°ãƒ¬ãƒ¼ï¼‰
            legendFontSize: 10,            // å‡¡ä¾‹ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º
            
            // ãƒ‡ãƒ¼ã‚¿ãƒ©ãƒ™ãƒ«è¨­å®š
            showValue: true,               // æ•°å€¤ã‚’è¡¨ç¤º
            dataLabelPosition: 't',        // ãƒ©ãƒ™ãƒ«ã®ä½ç½®ï¼ˆä¸Šï¼‰
            dataLabelColor: '363636',      // ãƒ©ãƒ™ãƒ«ã®è‰²ï¼ˆæ¿ƒã„ã‚°ãƒ¬ãƒ¼ï¼‰
            dataLabelFontSize: 10,         // ãƒ©ãƒ™ãƒ«ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º
            dataLabelFormatCode: '#,##0',  // æ•°å€¤ã®æ›¸å¼ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
            
            // ãƒãƒ£ãƒ¼ãƒˆã‚«ãƒ©ãƒ¼è¨­å®š
            chartColors: [                 // ã‚°ãƒ©ãƒ•ã®è‰²ãƒ‘ãƒ¬ãƒƒãƒˆ
              '4472C4', '70AD47', 'ED7D31', 'FFC000', 
              '5B9BD5', 'A5A5A5', '7030A0', '0070C0'
            ]
          };
    
          // 3.2 ã‚°ãƒ©ãƒ•ã®ç¨®é¡ã‚’æ±ºå®šï¼ˆæŒ‡å®šãŒãªã‘ã‚Œã°æ£’ã‚°ãƒ©ãƒ•ï¼‰
          let chartType = 'bar';  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
          
          // ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ãƒãƒ£ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã®ãƒªã‚¹ãƒˆ
          const supportedChartTypes = ['bar', 'line', 'pie', 'doughnut', 'area'];
          
          // æŒ‡å®šã•ã‚ŒãŸãƒãƒ£ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ä½¿ç”¨
          if (data.chartType && supportedChartTypes.includes(data.chartType)) {
            chartType = data.chartType;
          }
    
          // 3.3 ã‚°ãƒ©ãƒ•ã®ç¨®é¡ã«å¿œã˜ãŸç‰¹åˆ¥è¨­å®š
          if (chartType === 'doughnut' || chartType === 'pie') {
            // ãƒ‰ãƒ¼ãƒŠãƒ„ã‚°ãƒ©ãƒ•/å††ã‚°ãƒ©ãƒ•ã®å ´åˆ
            chartOpts = {
              ...chartOpts,                 // åŸºæœ¬è¨­å®šã‚’å¼•ãç¶™ã
              holeSize: chartType === 'doughnut' ? 50 : 0,  // ãƒ‰ãƒ¼ãƒŠãƒ„ã®å ´åˆã¯ç©´ã‚ã
              showLabel: true,              // ãƒ©ãƒ™ãƒ«ã‚’è¡¨ç¤º
              dataLabelPosition: 'bestFit', // ãƒ©ãƒ™ãƒ«ä½ç½®ã‚’è‡ªå‹•èª¿æ•´
              dataLabelColor: "FFFFFF",     // ãƒ©ãƒ™ãƒ«ã®è‰²ï¼ˆç™½ï¼‰
              dataLabelFontSize: 12,        // ãƒ©ãƒ™ãƒ«ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º
              dataLabelFontBold: true       // ãƒ©ãƒ™ãƒ«ã‚’å¤ªå­—ã«
            };
          } else if (chartType === 'line') {
            // æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ã®å ´åˆ
            chartOpts = {
              ...chartOpts,                 // åŸºæœ¬è¨­å®šã‚’å¼•ãç¶™ã
              
              // Xè»¸ï¼ˆã‚«ãƒ†ã‚´ãƒªè»¸ï¼‰ã®è¨­å®š
              catAxisLabelColor: "363636",  // ãƒ©ãƒ™ãƒ«ã®è‰²ï¼ˆæ¿ƒã„ã‚°ãƒ¬ãƒ¼ï¼‰
              catAxisLabelFontSize: 10,     // ãƒ©ãƒ™ãƒ«ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º
              catAxisLabelRotate: 0,        // ãƒ©ãƒ™ãƒ«ã‚’å›è»¢ã—ãªã„
              
              // Yè»¸ï¼ˆå€¤è»¸ï¼‰ã®è¨­å®š
              valAxisLabelColor: "363636",  // ãƒ©ãƒ™ãƒ«ã®è‰²ï¼ˆæ¿ƒã„ã‚°ãƒ¬ãƒ¼ï¼‰
              valAxisLabelFontSize: 10,     // ãƒ©ãƒ™ãƒ«ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º
              
              // ã‚°ãƒªãƒƒãƒ‰ç·šã®è¨­å®š
              valGridLine: { 
                color: "E1E1E1",            // ç·šã®è‰²ï¼ˆè–„ã„ã‚°ãƒ¬ãƒ¼ï¼‰
                style: "solid",             // ç·šã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå®Ÿç·šï¼‰
                size: 1                     // ç·šã®å¤ªã•
              },
              
              // ç·šã®è¨­å®š
              lineSize: 2,                  // ç·šã®å¤ªã•
              lineSmooth: false,            // ç›´ç·šï¼ˆã‚¹ãƒ ãƒ¼ã‚ºã«ã—ãªã„ï¼‰
              lineDataSymbol: 'circle',     // ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã®å½¢ï¼ˆå††ï¼‰
              lineDataSymbolSize: 6         // ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã®ã‚µã‚¤ã‚º
            };
          } else if (chartType === 'bar') {
            // æ£’ã‚°ãƒ©ãƒ•ã®å ´åˆ
            chartOpts = {
              ...chartOpts,                 // åŸºæœ¬è¨­å®šã‚’å¼•ãç¶™ã
              
              // æ£’ã‚°ãƒ©ãƒ•ã®è¨­å®š
              barDir: 'col',                // ç¸¦æ£’ã‚°ãƒ©ãƒ•
              barGrouping: 'clustered',     // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚ŒãŸæ£’ã‚°ãƒ©ãƒ•
              barGapWidthPct: 50,           // æ£’ã®é–“éš”ï¼ˆ50%ï¼‰
              
              // Xè»¸ï¼ˆã‚«ãƒ†ã‚´ãƒªè»¸ï¼‰ã®è¨­å®š
              catAxisLabelColor: "363636",  // ãƒ©ãƒ™ãƒ«ã®è‰²ï¼ˆæ¿ƒã„ã‚°ãƒ¬ãƒ¼ï¼‰
              catAxisLabelFontSize: 10,     // ãƒ©ãƒ™ãƒ«ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º
              catAxisLabelRotate: 0,        // ãƒ©ãƒ™ãƒ«ã‚’å›è»¢ã—ãªã„
              catAxisOrientation: 'minMax', // è»¸ã®å‘ã
              
              // Yè»¸ï¼ˆå€¤è»¸ï¼‰ã®è¨­å®š
              valAxisLabelColor: "363636",  // ãƒ©ãƒ™ãƒ«ã®è‰²ï¼ˆæ¿ƒã„ã‚°ãƒ¬ãƒ¼ï¼‰
              valAxisLabelFontSize: 10,     // ãƒ©ãƒ™ãƒ«ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º
              valAxisMaxVal: null,          // æœ€å¤§å€¤ï¼ˆè‡ªå‹•ï¼‰
              valAxisMinVal: 0,             // æœ€å°å€¤ï¼ˆ0ã‹ã‚‰é–‹å§‹ï¼‰
              
              // ã‚°ãƒªãƒƒãƒ‰ç·šã®è¨­å®š
              valGridLine: { 
                color: "E1E1E1",            // ç·šã®è‰²ï¼ˆè–„ã„ã‚°ãƒ¬ãƒ¼ï¼‰
                style: "solid",             // ç·šã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå®Ÿç·šï¼‰
                size: 1                     // ç·šã®å¤ªã•
              },
              
              // ãƒ‡ãƒ¼ã‚¿ãƒ©ãƒ™ãƒ«ã®ä½ç½®èª¿æ•´
              dataLabelPosition: 'outEnd',  // ãƒ©ãƒ™ãƒ«ã®ä½ç½®ï¼ˆæ£’ã®ä¸Šç«¯ã®å¤–å´ï¼‰
              dataLabelFormatCode: '#,##0'  // æ•°å€¤ã®æ›¸å¼ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
            };
          } else if (chartType === 'area') {
            // ã‚¨ãƒªã‚¢ãƒãƒ£ãƒ¼ãƒˆã®å ´åˆ
            chartOpts = {
              ...chartOpts,                 // åŸºæœ¬è¨­å®šã‚’å¼•ãç¶™ã
              
              // Xè»¸ï¼ˆã‚«ãƒ†ã‚´ãƒªè»¸ï¼‰ã®è¨­å®š
              catAxisLabelColor: "363636",  // ãƒ©ãƒ™ãƒ«ã®è‰²ï¼ˆæ¿ƒã„ã‚°ãƒ¬ãƒ¼ï¼‰
              catAxisLabelFontSize: 10,     // ãƒ©ãƒ™ãƒ«ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º
              
              // Yè»¸ï¼ˆå€¤è»¸ï¼‰ã®è¨­å®š
              valAxisLabelColor: "363636",  // ãƒ©ãƒ™ãƒ«ã®è‰²ï¼ˆæ¿ƒã„ã‚°ãƒ¬ãƒ¼ï¼‰
              valAxisLabelFontSize: 10,     // ãƒ©ãƒ™ãƒ«ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º
              valAxisMinVal: 0,             // æœ€å°å€¤ï¼ˆ0ã‹ã‚‰é–‹å§‹ï¼‰
              
              // ã‚°ãƒªãƒƒãƒ‰ç·šã®è¨­å®š
              valGridLine: { 
                color: "E1E1E1",            // ç·šã®è‰²ï¼ˆè–„ã„ã‚°ãƒ¬ãƒ¼ï¼‰
                style: "solid",             // ç·šã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå®Ÿç·šï¼‰
                size: 1                     // ç·šã®å¤ªã•
              },
              
              // å¡—ã‚Šã¤ã¶ã—ã®é€æ˜åº¦
              chartColorsOpacity: 0.7       // 70%ã®ä¸é€æ˜åº¦
            };
          }
    
          // 3.4 è¿½åŠ ã®ã‚«ã‚¹ã‚¿ãƒ è¨­å®šãŒã‚ã‚Œã°é©ç”¨ï¼ˆå®‰å…¨ã«ï¼‰
          if (data.chartOptions && typeof data.chartOptions === 'object') {
            // å®‰å…¨ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ã¿ã‚’ãƒãƒ¼ã‚¸
            const safeProps = [
              'x', 'y', 'w', 'h', 'barDir', 'barGrouping', 'barGapWidthPct',
              'chartColors', 'showTitle', 'titleColor', 'titleFontSize',
              'showLegend', 'legendPos', 'legendFontSize', 'legendColor',
              'showValue', 'dataLabelPosition', 'dataLabelColor', 'dataLabelFontSize',
              'catAxisLabelColor', 'catAxisLabelFontSize', 'catAxisLabelRotate',
              'valAxisLabelColor', 'valAxisLabelFontSize', 'valAxisMaxVal', 'valAxisMinVal'
            ];
            
            safeProps.forEach(prop => {
              if (data.chartOptions[prop] !== undefined) {
                chartOpts[prop] = data.chartOptions[prop];
              }
            });
          }
    
          // 3.5 ã‚°ãƒ©ãƒ•ã‚’ã‚¹ãƒ©ã‚¤ãƒ‰ã«è¿½åŠ 
          slide.addChart(chartType, validatedChartData, chartOpts);
        } catch (error) {
          console.error('ãƒãƒ£ãƒ¼ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', error);
          // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          slide.addText(`ã‚°ãƒ©ãƒ•ã®ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, { 
            x: 0.37,           // å·¦ã‹ã‚‰ã®ä½ç½®
            y: 1.86,           // ä¸Šã‹ã‚‰ã®ä½ç½®
            w: 12.60,          // å¹…
            h: 1.0,            // é«˜ã•
            fontSize: bodySize, 
            fontFace: DEFAULT_FONT_FACE,
            color: 'FF0000',   // ãƒ†ã‚­ã‚¹ãƒˆè‰²ï¼ˆèµ¤ï¼‰
            align: 'center',   // ä¸­å¤®æƒãˆ
            valign: 'middle'   // å‚ç›´ä¸­å¤®æƒãˆ
          });
        }
      } else {
        // 4. ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        slide.addText('ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', { 
          x: 0.37,           // å·¦ã‹ã‚‰ã®ä½ç½®
          y: 1.86,           // ä¸Šã‹ã‚‰ã®ä½ç½®
          w: 12.60,          // å¹…
          h: 1.0,            // é«˜ã•
          fontSize: bodySize, 
          fontFace: DEFAULT_FONT_FACE,
          color: 'FF0000',   // ãƒ†ã‚­ã‚¹ãƒˆè‰²ï¼ˆèµ¤ï¼‰
          align: 'center',   // ä¸­å¤®æƒãˆ
          valign: 'middle'   // å‚ç›´ä¸­å¤®æƒãˆ
        });
      }
    }



    
    // ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¹ãƒ©ã‚¤ãƒ‰
    function createCustomScheduleSlide(slide, data, pptx) {
      // ã‚¿ã‚¤ãƒˆãƒ«
      if (data.scheduleTitle) {
        slide.addText(data.scheduleTitle, { 
          x: 0.37, y: 0.35, w: 12.60, h: 0.59, 
          fontSize: TITLE_FONT_SIZE, 
          fontFace: DEFAULT_FONT_FACE 
        });
      }
      
      // æœˆã®è¡Œ
      if (data.includedMonths && Array.isArray(data.includedMonths)) {
        const monthRowOpts = { 
          x: 1.95, y: 1.24, w: 11.02, h: 0.48, 
          fontSize: 14, 
          fontFace: DEFAULT_FONT_FACE, 
          align: 'center', 
          valign: 'middle', 
          color: 'FFFFFF', 
          fill: '787878', 
          border: { pt: 3, color: 'FFFFFF' } 
        };
        slide.addTable([data.includedMonths], monthRowOpts);
      }
      
      // æ—¥ä»˜ç¯„å›²ã®è¡Œ
      if (data.weeklyWorkingDayRanges && Array.isArray(data.weeklyWorkingDayRanges)) {
        const dateRangeRowOpts = { 
          x: 1.95, y: 1.72, w: 11.02, h: 0.48, 
          fontSize: 7, 
          fontFace: DEFAULT_FONT_FACE, 
          align: 'center', 
          valign: 'middle', 
          color: 'FFFFFF', 
          fill: '262626', 
          border: { pt: 3, color: 'FFFFFF' } 
        };
        slide.addTable([data.weeklyWorkingDayRanges], dateRangeRowOpts);
      }
      
      // ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ
      if (data.taskList && Array.isArray(data.taskList)) {
        const scheduleDataOpts = { 
          x: 0.37, y: 2.40, w: 1.58, h: 4.50, 
          fontSize: 12, 
          fontFace: DEFAULT_FONT_FACE, 
          align: 'left', 
          valign: 'middle', 
          fill: 'F2F2F2', 
          border: { pt: 3, color: 'FFFFFF' } 
        };
        slide.addTable(data.taskList, scheduleDataOpts);
      }
      
      // ãƒ›ãƒ¼ãƒ ãƒ™ãƒ¼ã‚¹å‹ã®å›³å½¢ã‚’è¿½åŠ 
      if (data.taskCategories) {
        const homeBaseTexts = Array.isArray(data.taskCategories) ? data.taskCategories : [data.taskCategories];
        const shapeWidth = 1.5;
        const shapeHeight = 1.0;
        const startX = 2.07;
        const startY = 2.44;
        const spacingY = 0.1;
        
        homeBaseTexts.forEach((text, index) => {
          const yPos = startY + index * (shapeHeight + spacingY);
          slide.addText(text, {
            shape: pptx.shapes.CUSTOM_GEOMETRY,
            x: startX,
            y: yPos,
            w: shapeWidth,
            h: shapeHeight,
            fontSize: 11,
            fontFace: DEFAULT_FONT_FACE,
            color: "595959", // ãƒ†ã‚­ã‚¹ãƒˆè‰²ï¼šã‚°ãƒ¬ãƒ¼
            bold: true,
            align: "center",
            valign: "middle",
            fill: { color: "FFFFFF" }, // èƒŒæ™¯ï¼šç™½
            line: {
              color: "BFBFBF", // æ ç·šï¼šã‚°ãƒ¬ãƒ¼
              width: 1.0     // å¤ªã•ï¼š1pt
            },
            points: [
              { x: 1.7, y: 0.5 },   // å³ã¨ã‚“ãŒã‚Š
              { x: 1.6, y: 0.0 },   // ä¸Š
              { x: 0.0, y: 0.0 },   // å·¦ä¸Š
              { x: 0.0, y: 1.0 },   // å·¦ä¸‹
              { x: 1.6, y: 1.0 },   // ä¸‹
              { close: true }
            ]
          });
        });
      }
    }
    
    // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚¹ãƒ©ã‚¤ãƒ‰
    function createMilestoneSlide(slide, data, pptx) {
      // è¦ç´ 1: ã‚¿ã‚¤ãƒˆãƒ«
      if (data.milestoneSlideTitle) {
        slide.addText(data.milestoneSlideTitle, { 
          x: 0.37, y: 0.35, w: 12.60, h: 0.59, 
          fontSize: TITLE_FONT_SIZE, 
          fontFace: DEFAULT_FONT_FACE 
        });
      }
      
      // è¦ç´ 3: ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ (æ¦‚è¦)
      if (data.milestoneOverview) {
        slide.addText(data.milestoneOverview, {
          x: 2.67, y: -1.04, w: 2.96, h: 0.40,
          fontSize: BODY_FONT_SIZE, 
          fontFace: DEFAULT_FONT_FACE, 
          bold: true, 
          color: "C00000", 
          autoFit: true, 
          wordWrap: true
        });
      }
      
      // è¦ç´ 4: ãƒ†ãƒ¼ãƒ–ãƒ« (ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³å)
      if (data.milestoneNames && Array.isArray(data.milestoneNames)) {
        const table4Data = data.milestoneNames.map(row => [row]); // 1æ¬¡å…ƒé…åˆ—ã‚’2æ¬¡å…ƒé…åˆ—ã«å¤‰æ›
        const table4Opts = {
          x: 2.67, y: 1.51, w: 10.29, h: 5.39,
          fontSize: 16, 
          fontFace: DEFAULT_FONT_FACE, 
          bold: true, 
          color: "C00000", 
          align: 'left', 
          valign: 'middle',
          border: { pt: 0, color: 'FFFFFF' }, // æ ç·šãªã—
          fill: { color: 'FFFFFF', transparency: 100 } // èƒŒæ™¯è‰²ãªã—
        };
        slide.addTable(table4Data, table4Opts);
      }
      
      // è¦ç´ 5: ãƒ†ãƒ¼ãƒ–ãƒ« (ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³èª¬æ˜)
      if (data.milestoneDescriptions && Array.isArray(data.milestoneDescriptions)) {
        const table5Data = data.milestoneDescriptions.map(row => [row]); // 1æ¬¡å…ƒé…åˆ—ã‚’2æ¬¡å…ƒé…åˆ—ã«å¤‰æ›
        const table5Opts = {
          x: 2.67, y: 1.77, w: 10.29, h: 5.39,
          fontSize: 12, 
          fontFace: DEFAULT_FONT_FACE, 
          color: "595959", 
          align: 'left', 
          valign: 'middle',
          border: { pt: 0, color: 'FFFFFF' }, // æ ç·šãªã—
          fill: { color: 'FFFFFF', transparency: 100 } // èƒŒæ™¯è‰²ãªã—
        };
        slide.addTable(table5Data, table5Opts);
      }
      
      // è¦ç´ 6: ãƒ†ãƒ¼ãƒ–ãƒ« (æ¬¡ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã¾ã§ã®æ—¥æ•°)
      if (data.daysToNextMilestone && Array.isArray(data.daysToNextMilestone)) {
        const table6Data = data.daysToNextMilestone.map(row => [row]); // 1æ¬¡å…ƒé…åˆ—ã‚’2æ¬¡å…ƒé…åˆ—ã«å¤‰æ›
        const table6Opts = {
          x: 0.37, y: 2.05, w: 1.65, h: 4.31,
          fontSize: 16, 
          fontFace: DEFAULT_FONT_FACE, 
          bold: true, 
          color: "595959", 
          align: 'right', 
          valign: 'middle',
          border: { pt: 0, color: 'FFFFFF' }, // æ ç·šãªã—
          fill: { color: 'FFFFFF', transparency: 100 } // èƒŒæ™¯è‰²ãªã—
        };
        slide.addTable(table6Data, table6Opts);
      }
      
      // è¦ç´ 7: ãƒ†ãƒ¼ãƒ–ãƒ« (ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ãƒãƒ¼ã‚«ãƒ¼)
      if (data.milestoneMarkers && Array.isArray(data.milestoneMarkers)) {
        const table7Data = data.milestoneMarkers.map(row => [row]); // 1æ¬¡å…ƒé…åˆ—ã‚’2æ¬¡å…ƒé…åˆ—ã«å¤‰æ›
        const table7Opts = {
          x: 2.03, y: 1.51, w: 0.65, h: 5.39,
          fontSize: 20, 
          fontFace: DEFAULT_FONT_FACE, 
          bold: true, 
          color: "C00000", 
          align: 'center', 
          valign: 'middle',
          border: { pt: 0, color: 'FFFFFF' }, // æ ç·šãªã—
          fill: { color: 'FFFFFF', transparency: 100 } // èƒŒæ™¯è‰²ãªã—
        };
        slide.addTable(table7Data, table7Opts);
      }
      
      // ç¸¦ç·šã‚’è¿½åŠ 
      slide.addShape('rect', {
        x: 2.34,
        y: 1.3,
        w: 0.0266,
        h: 5.59,
        fill: { color: 'C00000' },
        line: { type: 'none' }  // æ ç·šãªã—
      });
    }
    
    // ãƒã‚¹ã‚¿ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’å®šç¾©
    function defineMasterSlide(pptx, logoPath) {
      try {
        pptx.defineSlideMaster({
          title: MASTER_SLIDE_TITLE,
          width: LAYOUT_WIDTH,
          height: LAYOUT_HEIGHT,
          background: { color: 'FFFFFF' }, // èƒŒæ™¯è‰²ã‚’ç™½ã«è¨­å®š
          objects: [
            // ãƒ­ã‚´ï¼ˆlogoPathãŒæä¾›ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿è¿½åŠ ï¼‰
            ...(logoPath ? [{ 'image': { x: 0.24, y: 6.95, w: 0.39, h: 0.39, path: logoPath } }] : []),
            // CONFIDENTIALãƒ†ã‚­ã‚¹ãƒˆ
            { 'text': { 
              text: 'CONFIDENTIAL', 
              options: { 
                x: 11.00, y: 6.99, w: 1.64, h: 0.30, 
                fontSize: 12, 
                fontFace: DEFAULT_FONT_FACE, 
                color: '000000', 
                bold: true, 
                align: 'right' 
              } 
            } }
          ],
          slideNumber: { 
            x: 12.73, y: 6.99, w: 0.50, h: 0.30, 
            color: '000000', 
            fontFace: DEFAULT_FONT_FACE, 
            fontSize: 12, 
            bold: true, 
            align: 'left' 
          }, // ã‚¹ãƒ©ã‚¤ãƒ‰ç•ªå·ã®è¨­å®š
          slideSize: { w: LAYOUT_WIDTH, h: LAYOUT_HEIGHT }
        });
        return true; // æ­£å¸¸ã«å®šç¾©ã•ã‚ŒãŸå ´åˆã¯trueã‚’è¿”ã™
      } catch (error) {
        console.error("ã‚¹ãƒ©ã‚¤ãƒ‰ãƒã‚¹ã‚¿ãƒ¼ã®å®šç¾©ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ", error);
        return false; // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯falseã‚’è¿”ã™
      }
    }
    
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    function getDefaultSlides() {
      return [
        {
          slidetype: 'default',
          title: 'ãƒ†ã‚­ã‚¹ãƒˆã‚¹ãƒ©ã‚¤ãƒ‰ä¾‹',
          heading: 'é€šå¸¸ãƒ†ã‚­ã‚¹ãƒˆï¼ˆç®‡æ¡æ›¸ããªã—ï¼‰',
          body: 'ã“ã‚Œã¯é€šå¸¸ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¹ãƒ©ã‚¤ãƒ‰ã§ã™ã€‚ç®‡æ¡æ›¸ãã§ã¯ãªãã€æ®µè½ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚é•·ã„ãƒ†ã‚­ã‚¹ãƒˆã®å ´åˆã¯è‡ªå‹•çš„ã«æŠ˜ã‚Šè¿”ã•ã‚Œã¦è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã“ã®ã‚ˆã†ã«ã—ã¦ã€èª¬æ˜æ–‡ã‚„æ¦‚è¦ãªã©ã‚’è¨˜è¿°ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚'
        },
        {
          slidetype: 'agenda',
          title: 'ã‚¢ã‚¸ã‚§ãƒ³ãƒ€',
          body: ['ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦', 'æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯', 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«', 'äºˆç®—']
        },
        {
          slidetype: 'table',
          title: 'ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ãƒ©ã‚¤ãƒ‰ä¾‹',
          heading: 'ãƒ‡ãƒ¼ã‚¿æ¯”è¼ƒè¡¨',
          tableData: [
            ['é …ç›®', '2021å¹´', '2022å¹´', '2023å¹´'],
            ['å£²ä¸Šé«˜', '1,000ä¸‡å††', '1,200ä¸‡å††', '1,500ä¸‡å††'],
            ['å–¶æ¥­åˆ©ç›Š', '200ä¸‡å††', '250ä¸‡å††', '300ä¸‡å††'],
            ['ç´”åˆ©ç›Š', '150ä¸‡å††', '180ä¸‡å††', '220ä¸‡å††']
          ]
        },
        {
          slidetype: 'chart',
          title: 'ãƒãƒ£ãƒ¼ãƒˆã‚¹ãƒ©ã‚¤ãƒ‰ä¾‹',
          heading: 'å£²ä¸Šæ¨ç§»ã‚°ãƒ©ãƒ•',
          chartTitle: 'å››åŠæœŸåˆ¥å£²ä¸Šï¼ˆå˜ä½ï¼šç™¾ä¸‡å††ï¼‰',
          chartType: 'bar',
          chartData: [
            {
              name: '2022å¹´',
              labels: ['Q1', 'Q2', 'Q3', 'Q4'],
              values: [120, 135, 140, 150]
            },
            {
              name: '2023å¹´',
              labels: ['Q1', 'Q2', 'Q3', 'Q4'],
              values: [150, 160, 165, 170]
            }
          ],
          showLegend: true
        },
        {
          slidetype: 'custom_schedule',
          scheduleTitle: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«',
          includedMonths: ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ'],
          weeklyWorkingDayRanges: ['1-7', '8-14', '15-21', '22-28', '1-7', '8-14', '15-21', '22-28', '1-7', '8-14', '15-21', '22-28', '1-7', '8-14', '15-21', '22-28'],
          taskList: [
            ['ã‚¿ã‚¹ã‚¯'],
            ['è¦ä»¶å®šç¾©'],
            ['è¨­è¨ˆ'],
            ['é–‹ç™º'],
            ['ãƒ†ã‚¹ãƒˆ'],
            ['ãƒªãƒªãƒ¼ã‚¹']
          ],
          taskCategories: ['ãƒ•ã‚§ãƒ¼ã‚º1', 'ãƒ•ã‚§ãƒ¼ã‚º2', 'ãƒ•ã‚§ãƒ¼ã‚º3']
        },
        {
          slidetype: 'milestone',
          milestoneSlideTitle: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³',
          milestoneOverview: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®é€²æ—çŠ¶æ³',
          milestoneNames: ['è¦ä»¶å®šç¾©å®Œäº†', 'è¨­è¨ˆå®Œäº†', 'é–‹ç™ºå®Œäº†', 'ãƒ†ã‚¹ãƒˆå®Œäº†', 'ãƒªãƒªãƒ¼ã‚¹'],
          milestoneDescriptions: ['è¦ä»¶å®šç¾©ãƒ•ã‚§ãƒ¼ã‚ºãŒå®Œäº†ã—ã€è¨­è¨ˆãƒ•ã‚§ãƒ¼ã‚ºã«ç§»è¡Œã—ã¾ã™', 'è¨­è¨ˆãƒ•ã‚§ãƒ¼ã‚ºãŒå®Œäº†ã—ã€é–‹ç™ºãƒ•ã‚§ãƒ¼ã‚ºã«ç§»è¡Œã—ã¾ã™', 'é–‹ç™ºãƒ•ã‚§ãƒ¼ã‚ºãŒå®Œäº†ã—ã€ãƒ†ã‚¹ãƒˆãƒ•ã‚§ãƒ¼ã‚ºã«ç§»è¡Œã—ã¾ã™', 'ãƒ†ã‚¹ãƒˆãƒ•ã‚§ãƒ¼ã‚ºãŒå®Œäº†ã—ã€ãƒªãƒªãƒ¼ã‚¹æº–å‚™ã«ç§»è¡Œã—ã¾ã™', 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œäº†ã€é‹ç”¨ãƒ•ã‚§ãƒ¼ã‚ºã«ç§»è¡Œã—ã¾ã™'],
          daysToNextMilestone: ['10æ—¥', '30æ—¥', '45æ—¥', '15æ—¥', '5æ—¥'],
          milestoneMarkers: ['â—', 'â—', 'â—', 'â—', 'â—']
        }
      ];
    }
    
    // JSONãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
    function createSlidesFromJson(pptx, jsonData, isPopup = false) {
      try {
        // JSONã‚’ãƒ‘ãƒ¼ã‚¹
        const slideData = JSON.parse(jsonData);
        // é…åˆ—ã§ãªã„å ´åˆã¯é…åˆ—ã«å¤‰æ›
        const slides = Array.isArray(slideData) ? slideData : [slideData];
        
        slides.forEach(info => {
          const slide = pptx.addSlide({ masterName: MASTER_SLIDE_TITLE });
          // ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ä½œæˆ
          createSlideByType(slide, info, pptx, isPopup);
        });
        
        return true;
      } catch (e) {
        console.error('JSONãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã®ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', e);
        return false;
      }
    }
    // å…¬é–‹API
    return {
      createSlideByType: createSlideByType,
      defineMasterSlide: defineMasterSlide,
      getDefaultSlides: getDefaultSlides,
      createSlidesFromJson: createSlidesFromJson,
      // å®šæ•°ã‚‚å…¬é–‹
      LAYOUT_WIDTH: LAYOUT_WIDTH,
      LAYOUT_HEIGHT: LAYOUT_HEIGHT,
      MASTER_SLIDE_TITLE: MASTER_SLIDE_TITLE,
      TITLE_FONT_SIZE: TITLE_FONT_SIZE,
      HEADING_FONT_SIZE: HEADING_FONT_SIZE,
      BODY_FONT_SIZE: BODY_FONT_SIZE,
      DEFAULT_FONT_FACE: DEFAULT_FONT_FACE,
      POPUP_TITLE_FONT_SIZE: POPUP_TITLE_FONT_SIZE,
      POPUP_HEADING_FONT_SIZE: POPUP_HEADING_FONT_SIZE,
      POPUP_BODY_FONT_SIZE: POPUP_BODY_FONT_SIZE
    };
  })();
  
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
  window.SlideCreator = SlideCreator;
  
  cat: jsonDetector.js: No such file or directory
cat: previewManager.js: No such file or directory
cat: slideGenerator.js: No such file or directory
cat: ui.js: No such file or directory
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>PPTX Preview</title>
  <style>
    body {
      width: 300px;
      padding: 10px;
      font-family: Arial, sans-serif;
    }
    h1 {
      font-size: 18px;
      margin-top: 0;
      color: #333;
    }
    button {
      background-color: #0078d4;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
      width: 100%;
    }
    button:hover {
      background-color: #005a9e;
    }
    .info {
      margin-top: 10px;
      font-size: 12px;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>PPTX Preview</h1>
  <p>ãƒšãƒ¼ã‚¸ã‹ã‚‰JSONãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡ºã—ã€PPTXã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
  <button id="make">ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆ</button>
  <div class="info">
    <p>å¯¾å¿œã™ã‚‹JSONãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:</p>
    <pre style="font-size: 10px; overflow: auto; max-height: 100px;">
[
  {
    "type": "default",
    "title": "ã‚¿ã‚¤ãƒˆãƒ«",
    "heading": "è¦‹å‡ºã—",
    "body": "é€šå¸¸ãƒ†ã‚­ã‚¹ãƒˆ"
  },
  {
    "type": "agenda",
    "title": "ã‚¢ã‚¸ã‚§ãƒ³ãƒ€",
    "body": ["é …ç›®1", "é …ç›®2", "é …ç›®3"]
  }
]
    </pre>
  </div>
  <script src="other/pptxgen.bundle.js"></script>
  <script src="slideCreator.js"></script>
  <script src="popup.js"></script>
</body>
</html>
/**
 * popup.js
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * ãƒ–ãƒ©ã‚¦ã‚¶æ‹¡å¼µã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ç”»é¢ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã€‚
 * â‘ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã®æ¥ç¶šç¢ºèª
 * â‘¡ãƒšãƒ¼ã‚¸ã‹ã‚‰ JSON æŠ½å‡º
 * â‘¢ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆ â†’ PPTX Blob åŒ–
 * â‘£ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
 * ã®ä¸€é€£ã®ãƒ•ãƒ­ãƒ¼ã‚’åˆ¶å¾¡ã—ã¾ã™ã€‚
 */

// ===== æ¥ç¶šé–¢é€£ã®é–¢æ•° =====
// æ¥ç¶šç¢ºèª
async function checkContentScriptConnection() {
  try {
    // ç¾åœ¨ã®ã‚¿ãƒ–ã‚’å–å¾—
    const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
    if (!tab || !tab.id) {
      console.error('ã‚¿ãƒ–ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return false;
    }
    
    // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
    try {
      await chrome.tabs.sendMessage(tab.id, { action: 'ping' });
      console.log('ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå¿œç­”ã—ã¾ã—ãŸ');
      return true;
    } catch (e) {
      console.log('ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå¿œç­”ã—ã¾ã›ã‚“ã€‚æ³¨å…¥ã‚’è©¦ã¿ã¾ã™...');
      
      // å¿…è¦ãªã™ã¹ã¦ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’é †ç•ªã«æ³¨å…¥
      try {
        await chrome.scripting.executeScript({
          target: { tabId: tab.id },
          files: ['other/pptxgen.bundle.js']
        });
        
        await chrome.scripting.executeScript({
          target: { tabId: tab.id },
          files: ['other/jquery.min.js', 'other/jszip.min.js']
        });
        
        await chrome.scripting.executeScript({
          target: { tabId: tab.id },
          files: ['slideCreator.js']
        });
        
        await chrome.scripting.executeScript({
          target: { tabId: tab.id },
          files: ['content.js']
        });
        
        console.log('ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ³¨å…¥ã—ã¾ã—ãŸ');
        
        // æ³¨å…¥å¾Œã«å†åº¦ç¢ºèª
        try {
          await chrome.tabs.sendMessage(tab.id, { action: 'ping' });
          console.log('ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæ­£å¸¸ã«å¿œç­”ã—ã¾ã—ãŸ');
          return true;
        } catch (innerError) {
          console.error('ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ³¨å…¥å¾Œã‚‚å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“', innerError);
          return false;
        }
      } catch (injectionError) {
        console.error('ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ³¨å…¥ã‚¨ãƒ©ãƒ¼:', injectionError);
        return false;
      }
    }
  } catch (e) {
    console.error('æ¥ç¶šç¢ºèªã‚¨ãƒ©ãƒ¼:', e);
    return false;
  }
}


// ===== JSONå–å¾—é–¢é€£ã®é–¢æ•° =====
// ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–¢æ•° - ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã‹ã‚‰JSONãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
async function scrapeJsonFromPage() {
  try {
    // ç¾åœ¨ã®ã‚¿ãƒ–ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
    const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
    if (!tab || !tab.id) {
      throw new Error('ã‚¿ãƒ–ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
    
    const results = await chrome.scripting.executeScript({
      target: { tabId: tab.id },
      function: getJsonFromPageScript
    });
    
    // çµæœã‚’å–å¾—
    if (!results || !results[0]) {
      console.error('[popup.js] ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡ŒçµæœãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
      alert("ãƒšãƒ¼ã‚¸ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      return null;
    }
    
    if (results[0].result && results[0].result.error) {
      const errorMsg = results[0].result.error;
      console.error('[popup.js] ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', errorMsg);
      alert(errorMsg);
      return null;
    }
    
    return results[0].result;
  } catch (e) {
    console.error('[popup.js] ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', e);
    alert("ãƒšãƒ¼ã‚¸ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    return null;
  }
}

// ãƒšãƒ¼ã‚¸å†…ã§JSONã‚’å–å¾—ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆexecuteScriptã§å®Ÿè¡Œã•ã‚Œã‚‹ï¼‰
function getJsonFromPageScript() {
  // ãƒšãƒ¼ã‚¸å†…ã®ã™ã¹ã¦ã®JSONã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’æ¢ã™
  const codeBlocks = document.querySelectorAll('code.language-json, pre');
  if (codeBlocks.length === 0) {
    return { error: "JSONãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚" };
  }
  
  // æœ‰åŠ¹ãªJSONã‚’å«ã‚€ãƒ–ãƒ­ãƒƒã‚¯ã‚’åé›†
  const validJsonBlocks = [];
  for (const block of codeBlocks) {
    try {
      // spanã‚¿ã‚°ã§åˆ†ã‹ã‚Œã¦ã„ã¦ã‚‚å…¨ä½“ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’é€£çµ
      const text = block.innerText || block.textContent;
      const jsonText = text.trim();

      JSON.parse(jsonText);

      // æœ‰åŠ¹ãªJSONãƒ–ãƒ­ãƒƒã‚¯ã¨ãã®ä½ç½®æƒ…å ±ã‚’ä¿å­˜
      const rect = block.getBoundingClientRect();
      validJsonBlocks.push({
        text: textContent,
        position: rect.top + window.scrollY, // ãƒšãƒ¼ã‚¸ä¸Šã®çµ¶å¯¾ä½ç½®
        element: block
      });
    } catch (e) {
      // JSONã¨ã—ã¦è§£æã§ããªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
      continue;
    }
  }
  
  if (validJsonBlocks.length === 0) {
    return { error: "æœ‰åŠ¹ãªJSONãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚" };
  }
  
  // ä½ç½®æƒ…å ±ã§ã‚½ãƒ¼ãƒˆï¼ˆä¸‹ã«ã‚ã‚‹ã‚‚ã®ãŒå¾Œã‚ã«æ¥ã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰
  validJsonBlocks.sort((a, b) => a.position - b.position);
  
  // æœ€å¾Œï¼ˆä¸€ç•ªä¸‹ï¼‰ã®JSONãƒ–ãƒ­ãƒƒã‚¯ã‚’å–å¾—
  const latestBlock = validJsonBlocks[validJsonBlocks.length - 1];
  
  // é¸æŠã•ã‚ŒãŸJSONãƒ–ãƒ­ãƒƒã‚¯ã‚’è¦–è¦šçš„ã«å¼·èª¿è¡¨ç¤º
  for (const block of validJsonBlocks) {
    if (block.element === latestBlock.element) {
      // é¸æŠã•ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯ã‚’å¼·èª¿è¡¨ç¤º
      block.element.style.border = '3px solid #4CAF50';
      block.element.style.boxShadow = '0 0 10px rgba(76, 175, 80, 0.7)';
      block.element.scrollIntoView({ behavior: 'smooth', block: 'center' });
    } else {
      // ä»–ã®JSONãƒ–ãƒ­ãƒƒã‚¯ã¯è–„ã„å¼·èª¿è¡¨ç¤º
      block.element.style.border = '1px solid #0078d4';
      block.element.style.boxShadow = '0 0 5px rgba(0, 120, 212, 0.3)';
    }
  }
  
  // æœ€æ–°ã®JSONãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
  return latestBlock.text;
}

// ===== ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é–¢é€£ã®é–¢æ•° =====
// ç›´æ¥ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
async function showPreviewDirectly(pptxBlob, jsonData) {
  try {
    // ç¾åœ¨ã®ã‚¿ãƒ–ã‚’å–å¾—
    const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
    if (!tab || !tab.id) {
      throw new Error('ã‚¿ãƒ–ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
    
    // Blobã‚’base64ã«å¤‰æ›
    const reader = new FileReader();
    reader.readAsDataURL(pptxBlob);
    reader.onloadend = async () => {
      const base64data = reader.result.split(',')[1]; // data:application/...base64, ã‚’é™¤å»
      
      // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
      try {
        await chrome.tabs.sendMessage(tab.id, {
          action: 'renderPreview',
          pptxB64: base64data,
          jsonData: jsonData
        });
        console.log('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸ');
      } catch (e) {
        console.error('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ã‚¨ãƒ©ãƒ¼:', e);
        alert('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
      }
    };
  } catch (e) {
    console.error('ç›´æ¥ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', e);
    alert('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
  }
}

// ===== ãƒ¡ã‚¤ãƒ³ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼ =====
// ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆã®å®Ÿè¡Œ
async function generateSlides() {
  try {
    // 0. ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã®æ¥ç¶šã‚’ç¢ºèª
    const connected = await checkContentScriptConnection();
    if (!connected) {
      alert("ãƒšãƒ¼ã‚¸ã¨ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    
    // 1. ãƒšãƒ¼ã‚¸ã‹ã‚‰JSONãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°
    const jsonData = await scrapeJsonFromPage();
    if (!jsonData) return;
    
    console.log('ğŸ“„ [popup.js] ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã—ãŸJSONãƒ‡ãƒ¼ã‚¿:', jsonData);
    
    // 2. ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆ
    const pptx = new PptxGenJS();
    pptx.defineLayout({ 
      name: 'myLayout', 
      width: SlideCreator.LAYOUT_WIDTH, 
      height: SlideCreator.LAYOUT_HEIGHT 
    });
    pptx.layout = 'myLayout';
    
    // ãƒã‚¹ã‚¿ãƒ¼å®šç¾©
    // ãƒ­ã‚´ã®ãƒ‘ã‚¹ã‚’å–å¾—ï¼ˆæ‹¡å¼µæ©Ÿèƒ½å†…ã®ãƒªã‚½ãƒ¼ã‚¹ï¼‰
    const logoPath = chrome.runtime.getURL('logo.png');
    SlideCreator.defineMasterSlide(pptx, logoPath);
    
    // JSONã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ç”Ÿæˆ
    const success = SlideCreator.createSlidesFromJson(pptx, jsonData, true);
    
    if (!success) {
      // å¤±æ•—ã—ãŸå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ä½¿ç”¨
      alert("JSONãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã®ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚");
      
      const defaultSlides = SlideCreator.getDefaultSlides();
      const defaultJson = JSON.stringify(defaultSlides);
      
      defaultSlides.forEach(info => {
        const slide = pptx.addSlide({ masterName: SlideCreator.MASTER_SLIDE_TITLE });
        SlideCreator.createSlideByType(slide, info, pptx, true);
      });
      
      // 3. Blobã¨ã—ã¦å‡ºåŠ›
      const blob = await pptx.write('blob');
      console.log('ğŸ“¤ [popup.js] PPTX Blob size =', blob.size);
      
      // 4. ç›´æ¥ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆJSONãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™ï¼‰
      await showPreviewDirectly(blob, defaultJson);
      return;
    }
    
    // 3. Blobã¨ã—ã¦å‡ºåŠ›
    const blob = await pptx.write('blob');
    console.log('ğŸ“¤ [popup.js] PPTX Blob size =', blob.size);
    
    // 4. ç›´æ¥ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºï¼ˆå…ƒã®JSONãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™ï¼‰
    await showPreviewDirectly(blob, jsonData);
  } catch (e) {
    console.error('[popup.js] ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼', e);
    alert("ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
  }
}


// ===== ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ =====
// ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
document.getElementById('make').addEventListener('click', generateSlides);

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
document.addEventListener('DOMContentLoaded', async () => {
  console.log('Popup loaded');
  // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã®æ¥ç¶šã‚’ç¢ºèª
  await checkContentScriptConnection();
});
{
  "manifest_version": 3,
  "name": "PPTX Preview with JSON Scraping",
  "version": "1.0.6",
  "description": "ãƒšãƒ¼ã‚¸ã‹ã‚‰JSONã‚’å–å¾—ã—ã¦PPTXã‚’ç”Ÿæˆã—ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ",
  "action": {
    "default_popup": "popup.html",
    "default_icon": {
      "16": "images/icon16.png",
      "32": "images/icon32.png",
      "48": "images/icon48.png",
      "128": "images/icon128.png"
    }
  },
  "permissions": ["activeTab", "scripting"],
  "icons": {
    "16":  "images/icon16.png",
    "32":  "images/icon32.png",
    "48":  "images/icon48.png",
    "128": "images/icon128.png"
  },
  "web_accessible_resources": [{
    "resources": [
      "logo.png",
      "images/Arrow.png",
      "slideCreator.js"
    ],
      "matches": [
        "https://r-ai.tsd.public.rakuten-it.com/*"
      ]
  }],
  "host_permissions": [
    "https://r-ai.tsd.public.rakuten-it.com/*"
  ],
  "content_scripts": [{
    "matches": [
      "https://r-ai.tsd.public.rakuten-it.com/*"
    ],
    "css": [
      "pptxjs/css/pptxjs.css",
      "pptxjs/css/nv.d3.min.css"
    ],
    "js": [

      "other/pptxgen.bundle.js",
      "other/jquery.min.js",
      "other/jszip.min.js",
      "slideCreator.js",
      "pptxjs/js/d3.min.js",
      "pptxjs/js/nv.d3.min.js",
      "pptxjs/js/dingbat.js",
      "pptxjs/filereader.js",
      "pptxjs/js/pptxjs.js",
      "pptxjs/js/divs2slides.js",

      "preview/ui.js",
      "preview/previewManager.js",
      "preview/jsonDetector.js",
      "preview/slideGenerator.js"

    ],
    "run_at": "document_idle"
  }],
  "content_security_policy": {
    "extension_pages": "script-src 'self'; object-src 'self';"
  }
}
