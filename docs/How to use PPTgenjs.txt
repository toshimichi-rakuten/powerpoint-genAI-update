ã§ã¯ä¸‹è¨˜ã®ã‚³ãƒ¼ãƒ‰ã‚’ç®¡ç†ã—ã‚„ã™ãæ•´ç†ã—ã¦ãã ã•ã„ã€‚å¤‰æ›´ãŒå¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚‚æ•™ãˆã¦ãã ã•ã„ã€‚
//content.js

// // ===== å®šæ•°ã¨è¨­å®š =====

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°

let latestBlob = null;

let slidePreviewImages = []; // ã‚¹ãƒ©ã‚¤ãƒ‰ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’ä¿å­˜ã™ã‚‹é…åˆ—

// ===== ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é–¢é€£ã®é–¢æ•° =====

// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ãƒ‘ãƒãƒ«ã‚’ä½œæˆ

// ===== è‡ªå‹•æ›´æ–°æ©Ÿèƒ½ =====

// å‰å›æ¤œå‡ºã—ãŸJSONãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹å¤‰æ•°

let lastDetectedJson = null;

let autoUpdateEnabled = true; // è‡ªå‹•æ›´æ–°ã®æœ‰åŠ¹/ç„¡åŠ¹ãƒ•ãƒ©ã‚°

let observerActive = false; // ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ¼ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‹ã©ã†ã‹

let observer = null; // MutationObserverã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹

// MutationObserverã‚’ä½¿ç”¨ã—ã¦ãƒšãƒ¼ã‚¸ã®å¤‰æ›´ã‚’ç›£è¦–ã™ã‚‹é–¢æ•°

function startJsonAutoDetection() {

  if (observerActive) return; // ã™ã§ã«ç›£è¦–ä¸­ãªã‚‰ä½•ã‚‚ã—ãªã„

  

  console.log('JSONè‡ªå‹•æ¤œå‡ºã‚’é–‹å§‹ã—ã¾ã™');

  

  // å‰å›ã®JSONã‚’ä¿å­˜

  lastDetectedJson = getJsonFromPage();

  

  // MutationObserverã®è¨­å®š

  observer = new MutationObserver((mutations) => {

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‘ãƒãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

    const previewPanel = document.getElementById('pptx-preview-panel');

    if (!previewPanel || !autoUpdateEnabled) {

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‘ãƒãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„ã‹ã€è‡ªå‹•æ›´æ–°ãŒç„¡åŠ¹ãªã‚‰å‡¦ç†ã—ãªã„

      return;

    }

    

    // å¤‰æ›´ãŒã‚ã£ãŸã‚‰JSONã‚’æ¤œå‡º

    const jsonData = getJsonFromPage();

    

    // JSONãŒè¦‹ã¤ã‹ã‚Šã€å‰å›ã¨ç•°ãªã‚‹å ´åˆã¯æ›´æ–°

    if (jsonData && jsonData !== lastDetectedJson) {

      console.log('æ–°ã—ã„JSONãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°ã—ã¾ã™ã€‚');

      lastDetectedJson = jsonData;

      

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°

      updatePreviewWithJson(jsonData);

    }

  });

  

  // ãƒšãƒ¼ã‚¸å…¨ä½“ã®å¤‰æ›´ã‚’ç›£è¦–

  observer.observe(document.body, {

    childList: true,

    subtree: true,

    characterData: true

  });

  

  observerActive = true;

  console.log('JSONè‡ªå‹•æ¤œå‡ºãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ');

}

// ç›£è¦–ã‚’åœæ­¢ã™ã‚‹é–¢æ•°

function stopJsonAutoDetection() {

  if (observer && observerActive) {

    observer.disconnect();

    observerActive = false;

    console.log('JSONè‡ªå‹•æ¤œå‡ºã‚’åœæ­¢ã—ã¾ã—ãŸ');

  }

}

// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‘ãƒãƒ«ã®ä½œæˆé–¢æ•°ã‚’ä¿®æ­£

function createPreviewPanel() {

  // æ—¢å­˜ã®ãƒ‘ãƒãƒ«ãŒã‚ã‚Œã°å‰Šé™¤

  const existingPanel = document.getElementById('pptx-preview-panel');

  if (existingPanel) {

    existingPanel.remove();

  }

  

  // ãƒšãƒ¼ã‚¸ã‚’å·¦ã«è©°ã‚ã‚‹ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 

  document.body.classList.add('pptx-preview-active');

  

  // ãƒ‘ãƒãƒ«æœ¬ä½“

  const panel = document.createElement('div');

  panel.id = 'pptx-preview-panel';

  

  // ãƒ˜ãƒƒãƒ€ãƒ¼

  const header = document.createElement('div');

  header.className = 'pp-header';

  header.innerHTML = `<h3>PPT Gen</h3>`;

  panel.appendChild(header);

  

  // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³

  const closeBtn = document.createElement('button');

  closeBtn.textContent = 'Ã—';

  closeBtn.className = 'pp-close-btn';

  closeBtn.onclick = () => {

    panel.remove();

    // ãƒšãƒ¼ã‚¸ã‚’å…ƒã«æˆ»ã™

    document.body.classList.remove('pptx-preview-active');

    // ãƒ‘ãƒãƒ«ãŒé–‰ã˜ã‚‰ã‚ŒãŸã‚‰ç›£è¦–ã‚’åœæ­¢

    stopJsonAutoDetection();

    // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°

    const toggleBtn = document.getElementById('pptx-preview-toggle');

    if (toggleBtn) {

      toggleBtn.classList.remove('panel-open');

    }

    isPanelVisible = false;

  };

  header.appendChild(closeBtn);

  

  // ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠï¼ˆãƒœã‚¿ãƒ³ã‚’æ¨ªã«ä¸¦ã¹ã‚‹ãŸã‚ï¼‰

  const buttonContainer = document.createElement('div');

  buttonContainer.className = 'pp-button-container';

  header.appendChild(buttonContainer);

  

  // è‡ªå‹•æ›´æ–°ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ - ãƒ†ã‚­ã‚¹ãƒˆã®ã¾ã¾

  const autoUpdateBtn = document.createElement('button');

  autoUpdateBtn.id = 'pptx-auto-update-btn';

  autoUpdateBtn.textContent = autoUpdateEnabled ? 'è‡ªå‹•æ›´æ–°: ON' : 'è‡ªå‹•æ›´æ–°: OFF';

  autoUpdateBtn.className = autoUpdateEnabled ? 'auto-update-on' : 'auto-update-off';

  autoUpdateBtn.onclick = () => {

    autoUpdateEnabled = !autoUpdateEnabled;

    autoUpdateBtn.textContent = autoUpdateEnabled ? 'è‡ªå‹•æ›´æ–°: ON' : 'è‡ªå‹•æ›´æ–°: OFF';

    autoUpdateBtn.className = autoUpdateEnabled ? 'auto-update-on' : 'auto-update-off';

    if (autoUpdateEnabled) {

      showUpdateNotification('è‡ªå‹•æ›´æ–°ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ');

      // æœ€æ–°ã®JSONã‚’å–å¾—ã—ã¦ä¿å­˜

      lastDetectedJson = getJsonFromPage();

    } else {

      showUpdateNotification('è‡ªå‹•æ›´æ–°ãŒç„¡åŠ¹ã«ãªã‚Šã¾ã—ãŸ');

    }

  };

  buttonContainer.appendChild(autoUpdateBtn);

  

  // æ›´æ–°ãƒœã‚¿ãƒ³ - ã‚¢ã‚¤ã‚³ãƒ³åŒ–

  const refreshBtn = document.createElement('button');

  refreshBtn.id = 'pptx-refresh-btn';

  refreshBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>';

  refreshBtn.title = 'æ›´æ–°';

  refreshBtn.onclick = async () => {

    try {

      // ãƒšãƒ¼ã‚¸ã‹ã‚‰JSONãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—

      const jsonData = getJsonFromPage();

      if (jsonData) {

        // JSONãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã€ãã‚Œã‚’ä½¿ç”¨

        console.log('ğŸ“„ [content.js] ãƒšãƒ¼ã‚¸ã‹ã‚‰JSONãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—:', jsonData);

        lastDetectedJson = jsonData; // æœ€æ–°ã®JSONã‚’ä¿å­˜

        // PPTXç”Ÿæˆ

        const pptx = new PptxGenJS();

        pptx.defineLayout({ 

          name: 'myLayout', 

          width: SlideCreator.LAYOUT_WIDTH, 

          height: SlideCreator.LAYOUT_HEIGHT 

        });

        pptx.layout = 'myLayout';

        // ãƒã‚¹ã‚¿ãƒ¼å®šç¾©

        // ãƒ­ã‚´ã®ãƒ‘ã‚¹ã‚’å–å¾—ï¼ˆæ‹¡å¼µæ©Ÿèƒ½å†…ã®ãƒªã‚½ãƒ¼ã‚¹ï¼‰

        const logoPath = chrome.runtime.getURL('logo.png');

        SlideCreator.defineMasterSlide(pptx, logoPath);

        // JSONãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ç”Ÿæˆ

        const success = SlideCreator.createSlidesFromJson(pptx, jsonData, false);

        if (!success) {

          // å¤±æ•—ã—ãŸå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ä½¿ç”¨

          alert("JSONãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã®ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚");

          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‡ãƒ¼ã‚¿

          const slideDataList = SlideCreator.getDefaultSlides();

          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’è¿½åŠ 

          slideDataList.forEach(data => {

            const slide = pptx.addSlide({ masterName: SlideCreator.MASTER_SLIDE_TITLE });

            SlideCreator.createSlideByType(slide, data, pptx, false);

          });

        }

        // Blob å–å¾—â†’ãƒ¬ãƒ³ãƒ€ãƒ¼

        const blob = await pptx.write('blob');

        renderPreview(blob, jsonData);

        // æ›´æ–°æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

        showUpdateNotification('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°ã—ã¾ã—ãŸ');

      } else {

        alert("ãƒšãƒ¼ã‚¸ã‹ã‚‰JSONãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");

      }

    } catch (error) {

      console.error('[content.js] ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);

      alert("ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");

    }

  };

  buttonContainer.appendChild(refreshBtn);

  

  // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ - ã‚¢ã‚¤ã‚³ãƒ³åŒ–

  const dlBtn = document.createElement('button');

  dlBtn.id = 'pptx-download-btn';

  dlBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"></path></svg>';

  dlBtn.title = 'ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ';

  dlBtn.onclick = () => {

    if (!latestBlob) return;

    const url = URL.createObjectURL(latestBlob);

    const a = document.createElement('a');

    a.href = url;

    a.download = 'presentation.pptx';

    a.click();

    URL.revokeObjectURL(url);

  };

  buttonContainer.appendChild(dlBtn);

  

  // ã‚¹ãƒ©ã‚¤ãƒ‰ä¸€è¦§ã‚³ãƒ³ãƒ†ãƒŠ

  const slidesContainer = document.createElement('div');

  slidesContainer.className = 'pp-slides';

  

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æç”»å…ˆ

  const view = document.createElement('div');

  view.id = 'pptx-preview-view';

  slidesContainer.appendChild(view);

  panel.appendChild(slidesContainer);

  document.body.appendChild(panel);

  

  // ãƒ‘ãƒãƒ«ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰è‡ªå‹•æ¤œå‡ºã‚’é–‹å§‹

  startJsonAutoDetection();

  

  // æœ€æ–°ã®JSONã‚’ä¿å­˜

  lastDetectedJson = getJsonFromPage();

  

  return panel;

}

// JSONãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°

async function updatePreviewWithJson(jsonData) {

  try {

    console.log('JSONãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°ã—ã¾ã™');

    

    // PPTXç”Ÿæˆ

    const pptx = new PptxGenJS();

    pptx.defineLayout({ 

      name: 'myLayout', 

      width: SlideCreator.LAYOUT_WIDTH, 

      height: SlideCreator.LAYOUT_HEIGHT 

    });

    pptx.layout = 'myLayout';

    

    // ãƒã‚¹ã‚¿ãƒ¼å®šç¾©

    const logoPath = chrome.runtime.getURL('logo.png');

    SlideCreator.defineMasterSlide(pptx, logoPath);

    

    // JSONãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ç”Ÿæˆ

    const success = SlideCreator.createSlidesFromJson(pptx, jsonData, false);

    

    if (!success) {

      console.error('JSONãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã®ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');

      showUpdateNotification('JSONãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã®ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');

      return;

    }

    

    // Blob å–å¾—â†’ãƒ¬ãƒ³ãƒ€ãƒ¼

    const blob = await pptx.write('blob');

    

    // æ—¢å­˜ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‘ãƒãƒ«ã‚’å–å¾—

    const existingPanel = document.getElementById('pptx-preview-panel');

    

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‘ãƒãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ã€ãã®ã¾ã¾æ›´æ–°

    if (existingPanel) {

      // ç¾åœ¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¿å­˜

      const slidesContainer = existingPanel.querySelector('.pp-slides');

      const scrollTop = slidesContainer ? slidesContainer.scrollTop : 0;

      

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’ç”Ÿæˆ

      const previewImages = generateSlidePreviewImages(jsonData);

      

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’è¡¨ç¤º

      const view = document.getElementById('pptx-preview-view');

      if (view) {

        view.innerHTML = '';

        

        if (previewImages && previewImages.length > 0) {

          previewImages.forEach(html => {

            try {

              // ã‚¹ãƒ©ã‚¤ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ

              const container = document.createElement('div');

              container.className = 'slide-container';

              

              // ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ã‚³ãƒ³ãƒ†ãƒŠã«è¿½åŠ 

              const slideDiv = document.createElement('div');

              slideDiv.innerHTML = html;

              

              if (slideDiv.firstElementChild) {

                container.appendChild(slideDiv.firstElementChild);

                // ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ“ãƒ¥ãƒ¼ã«è¿½åŠ 

                view.appendChild(container);

              }

            } catch (slideError) {

              console.error('Error creating slide:', slideError);

            }

          });

          

          // ã‚¹ã‚±ãƒ«ãƒˆãƒ³ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚’å®Ÿéš›ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ç½®ãæ›ãˆã‚‹

          setTimeout(() => {

            try {

              const realContents = document.querySelectorAll('.real-content');

              realContents.forEach(content => {

                content.classList.remove('hidden-content');

                content.classList.add('visible-content');

              });

              

              // ã‚¹ã‚±ãƒ«ãƒˆãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹

              const skeletons = document.querySelectorAll('.skeleton');

              skeletons.forEach(skeleton => {

                skeleton.style.display = 'none';

              });

              

              // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒ

              if (slidesContainer) {

                slidesContainer.scrollTop = scrollTop;

              }

            } catch (animationError) {

              console.error('Error during animation transition:', animationError);

            }

          }, 1000);

        }

      }

      

      // Blobã‚’ä¿å­˜

      latestBlob = blob;

      

      // æ›´æ–°é€šçŸ¥

      showUpdateNotification('æ–°ã—ã„JSONãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡ºã—ã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°ã—ã¾ã—ãŸ');

    } else {

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‘ãƒãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã€æ–°ã—ãä½œæˆ

      renderPreview(blob, jsonData);

    }

  } catch (error) {

    console.error('[content.js] è‡ªå‹•æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);

    showUpdateNotification('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');

  }

}

// æ›´æ–°é€šçŸ¥ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°ï¼ˆã‚¿ã‚¤ãƒ—ä»˜ãï¼‰

function showUpdateNotification(message, type = 'success') {

  // ã™ã§ã«é€šçŸ¥ãŒã‚ã‚Œã°å‰Šé™¤

  const existingNotification = document.querySelector('.update-notification');

  if (existingNotification) {

    existingNotification.remove();

  }

  

  const notification = document.createElement('div');

  notification.className = `update-notification ${type}`;

  notification.textContent = message;

  

  document.body.appendChild(notification);

  

  // è¡¨ç¤ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³

  setTimeout(() => notification.classList.add('show'), 100);

  

  // 3ç§’å¾Œã«æ¶ˆãˆã‚‹

  setTimeout(() => {

    notification.classList.remove('show');

    setTimeout(() => notification.remove(), 300);

  }, 3000);

}

// ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°

function generateSlidePreviewImages(jsonData) {

  try {

    // JSONã‚’ãƒ‘ãƒ¼ã‚¹

    const data = JSON.parse(jsonData);

    const slides = Array.isArray(data) ? data : [data];

    

    // ç”»åƒé…åˆ—ã‚’ã‚¯ãƒªã‚¢

    slidePreviewImages = [];

    

    // å„ã‚¹ãƒ©ã‚¤ãƒ‰ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’ç”Ÿæˆ

    slides.forEach((slideData, index) => {

      // slidetype ã¾ãŸã¯ type ã‚’å–å¾—ï¼ˆslidetypeã‚’å„ªå…ˆï¼‰

      const slideType = slideData.slidetype || slideData.type || 'default';

      let previewHtml = '';

      

      // ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’ç”Ÿæˆ

      switch (slideType) {

        case 'default':

          previewHtml = generateDefaultSlidePreview(slideData, index);

          break;

        case 'agenda':

          previewHtml = generateAgendaSlidePreview(slideData, index);

          break;

        case 'table':

          previewHtml = generateTableSlidePreview(slideData, index);

          break;

        case 'chart':

          previewHtml = generateChartSlidePreview(slideData, index);

          break;

        case 'custom_schedule':

          previewHtml = generateScheduleSlidePreview(slideData, index);

          break;

        case 'milestone':

          previewHtml = generateMilestoneSlidePreview(slideData, index);

          break;

        default:

          previewHtml = generateDefaultSlidePreview(slideData, index);

      }

      

      slidePreviewImages.push(previewHtml);

    });

    

    return slidePreviewImages;

  } catch (e) {

    console.error('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒç”Ÿæˆã‚¨ãƒ©ãƒ¼:', e);

    return [];

  }

}

// ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚¹ãƒ©ã‚¤ãƒ‰ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’ç”Ÿæˆ

function generateMilestoneSlidePreview(data, index) {

  const title = data.milestoneSlideTitle || '';

  const overview = data.milestoneOverview || '';

  const milestoneNames = data.milestoneNames || [];

  const milestoneDescriptions = data.milestoneDescriptions || [];

  const daysToNextMilestone = data.daysToNextMilestone || [];

  const milestoneMarkers = data.milestoneMarkers || [];

  

  // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é …ç›®ã‚’ç”Ÿæˆ

  let milestonesHtml = '';

  

  if (milestoneNames.length > 0) {

    milestonesHtml = '<div class="milestone-container">';

    

    // ç¸¦ç·š

    milestonesHtml += '<div class="milestone-line"></div>';

    

    // æ—¥æ•°

    milestonesHtml += '<div class="milestone-days">';

    daysToNextMilestone.forEach(day => {

      milestonesHtml += `<div class="milestone-day">${escapeHtml(day)}</div>`;

    });

    milestonesHtml += '</div>';

    

    // ãƒãƒ¼ã‚«ãƒ¼

    milestonesHtml += '<div class="milestone-markers">';

    milestoneMarkers.forEach(marker => {

      milestonesHtml += `<div class="milestone-marker">${escapeHtml(marker)}</div>`;

    });

    milestonesHtml += '</div>';

    

    // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³åã¨èª¬æ˜

    milestonesHtml += '<div class="milestone-content">';

    for (let i = 0; i < milestoneNames.length; i++) {

      const name = milestoneNames[i] || '';

      const description = i < milestoneDescriptions.length ? milestoneDescriptions[i] : '';

      

      milestonesHtml += `

        <div class="milestone-item">

          <div class="milestone-name">${escapeHtml(name)}</div>

          <div class="milestone-description">${escapeHtml(description)}</div>

        </div>

      `;

    }

    milestonesHtml += '</div>';

    

    milestonesHtml += '</div>';

  }

  

  return `

    <div class="slide-preview" data-index="${index}">

      <div class="slide-content milestone-slide">

        <!-- ã‚¹ã‚±ãƒ«ãƒˆãƒ³ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ -->

        <div class="skeleton-title skeleton"></div>

        <div class="skeleton-milestone skeleton"></div>

        

        <!-- å®Ÿéš›ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆæœ€åˆã¯éè¡¨ç¤ºï¼‰ -->

        <div class="real-content hidden-content">

          <div class="slide-title">${escapeHtml(title)}</div>

          ${overview ? `<div class="milestone-overview">${escapeHtml(overview)}</div>` : ''}

          ${milestonesHtml}

        </div>

        

        <div class="slide-number">${index + 1}</div>

      </div>

    </div>

  `;

}

// ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¹ãƒ©ã‚¤ãƒ‰ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’ç”Ÿæˆ

function generateScheduleSlidePreview(data, index) {

  const title = data.scheduleTitle || '';

  const months = data.includedMonths || [];

  const weekRanges = data.weeklyWorkingDayRanges || [];

  const taskList = data.taskList || [];

  const taskCategories = Array.isArray(data.taskCategories) ? data.taskCategories : [data.taskCategories];

  

  // æœˆã®è¡Œã‚’ç”Ÿæˆ

  let monthsHtml = '';

  if (months.length > 0) {

    monthsHtml = '<div class="schedule-months">';

    months.forEach(month => {

      monthsHtml += `<div class="month-cell">${escapeHtml(month)}</div>`;

    });

    monthsHtml += '</div>';

  }

  

  // é€±ã®ç¯„å›²è¡Œã‚’ç”Ÿæˆ

  let weeksHtml = '';

  if (weekRanges.length > 0) {

    weeksHtml = '<div class="schedule-weeks">';

    weekRanges.forEach(week => {

      weeksHtml += `<div class="week-cell">${escapeHtml(week)}</div>`;

    });

    weeksHtml += '</div>';

  }

  

  // ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ

  let tasksHtml = '';

  if (taskList.length > 0) {

    tasksHtml = '<div class="schedule-tasks">';

    taskList.forEach(task => {

      if (Array.isArray(task) && task.length > 0) {

        tasksHtml += `<div class="task-item">${escapeHtml(task[0])}</div>`;

      }

    });

    tasksHtml += '</div>';

  }

  

  // ã‚¿ã‚¹ã‚¯ã‚«ãƒ†ã‚´ãƒªï¼ˆãƒ›ãƒ¼ãƒ ãƒ™ãƒ¼ã‚¹å‹ï¼‰ã‚’ç”Ÿæˆ

  let categoriesHtml = '';

  if (taskCategories.length > 0) {

    categoriesHtml = '<div class="task-categories">';

    taskCategories.forEach(category => {

      categoriesHtml += `

        <div class="task-category">

          <svg width="100" height="40" viewBox="0 0 100 40" xmlns="http://www.w3.org/2000/svg">

            <path d="M0,0 L0,40 L80,40 L100,20 L80,0 Z" fill="white" stroke="#BFBFBF" stroke-width="1"/>

            <text x="40" y="25" text-anchor="middle" font-family="Arial" font-size="12" fill="#595959" font-weight="bold">${escapeHtml(category)}</text>

          </svg>

        </div>

      `;

    });

    categoriesHtml += '</div>';

  }

  

  return `

    <div class="slide-preview" data-index="${index}">

      <div class="slide-content schedule-slide">

        <!-- ã‚¹ã‚±ãƒ«ãƒˆãƒ³ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ -->

        <div class="skeleton-title skeleton"></div>

        <div class="skeleton-schedule skeleton"></div>

        

        <!-- å®Ÿéš›ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆæœ€åˆã¯éè¡¨ç¤ºï¼‰ -->

        <div class="real-content hidden-content">

          <div class="slide-title">${escapeHtml(title)}</div>

          <div class="schedule-container">

            ${monthsHtml}

            ${weeksHtml}

            <div class="schedule-body">

              ${tasksHtml}

              ${categoriesHtml}

            </div>

          </div>

        </div>

        

      

        <div class="slide-number">${index + 1}</div>

      </div>

    </div>

  `;

}

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒ©ã‚¤ãƒ‰ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’ç”Ÿæˆ

function generateDefaultSlidePreview(data, index) {

  const title = data.title || '';

  const heading = data.heading || '';

  const body = Array.isArray(data.body) ? data.body.join('<br><br>') : (data.body || '');

  const items = Array.isArray(data.items) ? data.items.join('<br><br>') : (data.items || '');

  const bodyText = body || items;

  

  return `

    <div class="slide-preview" data-index="${index}">

      <div class="slide-number">${index + 1}</div>

      <div class="slide-content default-slide">

        <div class="slide-title">${escapeHtml(title)}</div>

        ${heading ? `<div class="slide-heading">${escapeHtml(heading)}</div>` : ''}

        ${bodyText ? `<div class="slide-body">${escapeHtml(bodyText)}</div>` : ''}

      </div>

    </div>

  `;

}

// ã‚¢ã‚¸ã‚§ãƒ³ãƒ€ã‚¹ãƒ©ã‚¤ãƒ‰ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’ç”Ÿæˆ

function generateAgendaSlidePreview(data, index) {

  const title = data.title || '';

  const items = Array.isArray(data.body) ? data.body : (data.items || []);

  

  let itemsHtml = '';

  if (items.length > 0) {

    itemsHtml = '<ul class="agenda-items">';

    items.forEach((item, i) => {

      itemsHtml += `<li>${i + 1}. ${escapeHtml(item)}</li>`;

    });

    itemsHtml += '</ul>';

  }

  

  return `

    <div class="slide-preview" data-index="${index}">

      <div class="slide-number">${index + 1}</div>

      <div class="slide-content agenda-slide">

        <div class="slide-title">${escapeHtml(title)}</div>

        ${itemsHtml}

      </div>

    </div>

  `;

}

// ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ãƒ©ã‚¤ãƒ‰ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’ç”Ÿæˆ

function generateTableSlidePreview(data, index) {

  const title = data.title || '';

  const heading = data.heading || '';

  const tableData = data.tableData || [];

  

  let tableHtml = '';

  if (tableData.length > 0) {

    tableHtml = '<table class="preview-table">';

    

    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ

    tableHtml += '<tr class="table-header">';

    if (tableData[0] && Array.isArray(tableData[0])) {

      tableData[0].forEach(cell => {

        tableHtml += `<th>${escapeHtml(cell)}</th>`;

      });

    }

    tableHtml += '</tr>';

    

    // ãƒ‡ãƒ¼ã‚¿è¡Œ

    for (let i = 1; i < tableData.length; i++) {

      tableHtml += '<tr>';

      if (Array.isArray(tableData[i])) {

        tableData[i].forEach(cell => {

          tableHtml += `<td>${escapeHtml(cell)}</td>`;

        });

      }

      tableHtml += '</tr>';

    }

    

    tableHtml += '</table>';

  }

  

  return `

    <div class="slide-preview" data-index="${index}">

      <div class="slide-number">${index + 1}</div>

      <div class="slide-content table-slide">

        <div class="slide-title">${escapeHtml(title)}</div>

        ${heading ? `<div class="slide-heading">${escapeHtml(heading)}</div>` : ''}

        <div class="table-container">

          ${tableHtml}

        </div>

      </div>

    </div>

  `;

}

// ãƒãƒ£ãƒ¼ãƒˆã‚¹ãƒ©ã‚¤ãƒ‰ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’ç”Ÿæˆ

function generateChartSlidePreview(data, index) {

  const title = data.title || '';

  const heading = data.heading || '';

  const chartTitle = data.chartTitle || '';

  const chartType = data.chartType || 'bar';

  const chartData = data.chartData || [];

  

  // ãƒãƒ£ãƒ¼ãƒˆã®SVGè¡¨ç¾ã‚’ç”Ÿæˆ

  let chartSvg = generateChartSvg(chartType, chartData, {

    title: chartTitle,

    showLegend: data.showLegend

  });

  

  return `

    <div class="slide-preview" data-index="${index}">

      <div class="slide-content chart-slide">

        <!-- ã‚¹ã‚±ãƒ«ãƒˆãƒ³ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ -->

        <div class="skeleton-title skeleton"></div>

        ${heading ? `<div class="skeleton-heading skeleton"></div>` : ''}

        <div class="skeleton-chart skeleton"></div>

        

        <!-- å®Ÿéš›ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆæœ€åˆã¯éè¡¨ç¤ºï¼‰ -->

        <div class="real-content hidden-content">

          <div class="slide-title">${escapeHtml(title)}</div>

          ${heading ? `<div class="slide-heading">${escapeHtml(heading)}</div>` : ''}

          <div class="chart-container">

            ${chartSvg}

          </div>

        </div>

        

        <div class="slide-number">${index + 1}</div>

      </div>

    </div>

  `;

}

// ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‹ã‚‰SVGç”»åƒã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°

function generateChartSvg(chartType, chartData, options = {}) {

  const width = 870;

  const height = 350;

  const padding = 40;

  const chartTitle = options.title || '';

  const showLegend = options.showLegend || false;

  

  // åŸºæœ¬çš„ãªSVGæ§‹é€ 

  let svg = `<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">`;

  svg += `<rect width="${width}" height="${height}" fill="#ffffff" rx="5" ry="5"/>`;

  

  // ãƒãƒ£ãƒ¼ãƒˆã‚¿ã‚¤ãƒˆãƒ«

  if (chartTitle) {

    svg += `<text x="${width/2}" y="25" text-anchor="middle" font-family="Arial" font-size="16" font-weight="bold">${escapeHtml(chartTitle)}</text>`;

  }

  

  // ãƒãƒ£ãƒ¼ãƒˆã®ç¨®é¡ã«å¿œã˜ãŸæç”»

  if (chartType === 'bar') {

    svg += generateBarChartSvg(chartData, width, height, padding, showLegend);

  } else if (chartType === 'line') {

    svg += generateLineChartSvg(chartData, width, height, padding, showLegend);

  } else if (chartType === 'doughnut' || chartType === 'pie') {

    svg += generatePieChartSvg(chartData, width, height, padding, showLegend, chartType === 'doughnut');

  }

  

  svg += '</svg>';

  return svg;

}

// æ£’ã‚°ãƒ©ãƒ•ã®SVGç”Ÿæˆ

function generateBarChartSvg(chartData, width, height, padding, showLegend) {

  if (!chartData || chartData.length === 0) return '';

  

  const chartWidth = width - padding * 2;

  const chartHeight = height - padding * 2 - (showLegend ? 40 : 0);

  const startY = padding + 30; // ã‚¿ã‚¤ãƒˆãƒ«ç”¨ã®ä½™ç™½

  

  // ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‹ã‚‰ãƒ©ãƒ™ãƒ«ã¨æœ€å¤§å€¤ã‚’å–å¾—

  const allLabels = chartData[0].labels || [];

  let maxValue = 0;

  

  chartData.forEach(dataset => {

    const values = dataset.values || [];

    const datasetMax = Math.max(...values);

    if (datasetMax > maxValue) maxValue = datasetMax;

  });

  

  // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ä¿‚æ•°

  const yScale = chartHeight / (maxValue * 1.1);

  const barWidth = chartWidth / (allLabels.length * chartData.length + chartData.length);

  const groupWidth = barWidth * chartData.length;

  

  // è‰²ã®é…åˆ—

  const colors = ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#8E24AA', '#16A2D7', '#FB8C00'];

  

  let svg = '';

  

  // Xè»¸

  svg += `<line x1="${padding}" y1="${startY + chartHeight}" x2="${width - padding}" y2="${startY + chartHeight}" stroke="#666" stroke-width="1"/>`;

  

  // Yè»¸

  svg += `<line x1="${padding}" y1="${startY}" x2="${padding}" y2="${startY + chartHeight}" stroke="#666" stroke-width="1"/>`;

  

  // Xè»¸ãƒ©ãƒ™ãƒ«

  allLabels.forEach((label, i) => {

    const x = padding + (i * (groupWidth + barWidth)) + groupWidth / 2;

    svg += `<text x="${x}" y="${startY + chartHeight + 20}" text-anchor="middle" font-family="Arial" font-size="12">${escapeHtml(label)}</text>`;

  });

  

  // Yè»¸ãƒ©ãƒ™ãƒ«ï¼ˆ5åˆ†å‰²ï¼‰

  for (let i = 0; i <= 5; i++) {

    const value = Math.round(maxValue * i / 5);

    const y = startY + chartHeight - (value * yScale);

    svg += `<text x="${padding - 10}" y="${y + 5}" text-anchor="end" font-family="Arial" font-size="12">${value}</text>`;

    svg += `<line x1="${padding}" y1="${y}" x2="${width - padding}" y2="${y}" stroke="#ddd" stroke-width="1" stroke-dasharray="5,5"/>`;

  }

  

  // æ£’ã‚°ãƒ©ãƒ•ã®æç”»

  chartData.forEach((dataset, datasetIndex) => {

    const values = dataset.values || [];

    const color = colors[datasetIndex % colors.length];

    

    values.forEach((value, i) => {

      const barHeight = value * yScale;

      const x = padding + (i * (groupWidth + barWidth)) + (datasetIndex * barWidth);

      const y = startY + chartHeight - barHeight;

      

      svg += `<rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" fill="${color}" stroke="#fff" stroke-width="1">`;

      svg += `<title>${dataset.name}: ${value}</title>`;

      svg += `</rect>`;

      

      // å€¤ãƒ©ãƒ™ãƒ«

      svg += `<text x="${x + barWidth/2}" y="${y - 5}" text-anchor="middle" font-family="Arial" font-size="11">${value}</text>`;

    });

  });

  

  // å‡¡ä¾‹

  if (showLegend) {

    const legendY = height - 25;

    const legendItemWidth = width / chartData.length;

    

    chartData.forEach((dataset, i) => {

      const x = padding + (i * legendItemWidth);

      const color = colors[i % colors.length];

      

      svg += `<rect x="${x}" y="${legendY}" width="10" height="10" fill="${color}"/>`;

      svg += `<text x="${x + 15}" y="${legendY + 9}" font-family="Arial" font-size="12">${escapeHtml(dataset.name)}</text>`;

    });

  }

  

  return svg;

}

// æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ã®SVGç”Ÿæˆ

function generateLineChartSvg(chartData, width, height, padding, showLegend) {

  if (!chartData || chartData.length === 0) return '';

  

  const chartWidth = width - padding * 2;

  const chartHeight = height - padding * 2 - (showLegend ? 40 : 0);

  const startY = padding + 30; // ã‚¿ã‚¤ãƒˆãƒ«ç”¨ã®ä½™ç™½

  

  // ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‹ã‚‰ãƒ©ãƒ™ãƒ«ã¨æœ€å¤§å€¤ã‚’å–å¾—

  const allLabels = chartData[0].labels || [];

  let maxValue = 0;

  

  chartData.forEach(dataset => {

    const values = dataset.values || [];

    const datasetMax = Math.max(...values);

    if (datasetMax > maxValue) maxValue = datasetMax;

  });

  

  // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ä¿‚æ•°

  const yScale = chartHeight / (maxValue * 1.1);

  const xScale = chartWidth / (allLabels.length - 1 || 1);

  

  // è‰²ã®é…åˆ—

  const colors = ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#8E24AA', '#16A2D7', '#FB8C00'];

  

  let svg = '';

  

  // Xè»¸

  svg += `<line x1="${padding}" y1="${startY + chartHeight}" x2="${width - padding}" y2="${startY + chartHeight}" stroke="#666" stroke-width="1"/>`;

  

  // Yè»¸

  svg += `<line x1="${padding}" y1="${startY}" x2="${padding}" y2="${startY + chartHeight}" stroke="#666" stroke-width="1"/>`;

  

  // Xè»¸ãƒ©ãƒ™ãƒ«

  allLabels.forEach((label, i) => {

    const x = padding + (i * xScale);

    svg += `<text x="${x}" y="${startY + chartHeight + 20}" text-anchor="middle" font-family="Arial" font-size="12">${escapeHtml(label)}</text>`;

  });

  

  // Yè»¸ãƒ©ãƒ™ãƒ«ï¼ˆ5åˆ†å‰²ï¼‰

  for (let i = 0; i <= 5; i++) {

    const value = Math.round(maxValue * i / 5);

    const y = startY + chartHeight - (value * yScale);

    svg += `<text x="${padding - 10}" y="${y + 5}" text-anchor="end" font-family="Arial" font-size="12">${value}</text>`;

    svg += `<line x1="${padding}" y1="${y}" x2="${width - padding}" y2="${y}" stroke="#ddd" stroke-width="1" stroke-dasharray="5,5"/>`;

  }

  

  // æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ã®æç”»

  chartData.forEach((dataset, datasetIndex) => {

    const values = dataset.values || [];

    const color = colors[datasetIndex % colors.length];

    

    // ç·šã‚’æç”»

    let pathData = '';

    values.forEach((value, i) => {

      const x = padding + (i * xScale);

      const y = startY + chartHeight - (value * yScale);

      

      if (i === 0) {

        pathData += `M ${x} ${y}`;

      } else {

        pathData += ` L ${x} ${y}`;

      }

    });

    

    svg += `<path d="${pathData}" fill="none" stroke="${color}" stroke-width="2"/>`;

    

    // ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã‚’æç”»

    values.forEach((value, i) => {

      const x = padding + (i * xScale);

      const y = startY + chartHeight - (value * yScale);

      

      svg += `<circle cx="${x}" cy="${y}" r="4" fill="${color}" stroke="#fff" stroke-width="1">`;

      svg += `<title>${dataset.name}: ${value}</title>`;

      svg += `</circle>`;

      

      // å€¤ãƒ©ãƒ™ãƒ«

      svg += `<text x="${x}" y="${y - 10}" text-anchor="middle" font-family="Arial" font-size="11">${value}</text>`;

    });

  });

  

  // å‡¡ä¾‹

  if (showLegend) {

    const legendY = height - 25;

    const legendItemWidth = width / chartData.length;

    

    chartData.forEach((dataset, i) => {

      const x = padding + (i * legendItemWidth);

      const color = colors[i % colors.length];

      

      svg += `<line x1="${x}" y1="${legendY + 5}" x2="${x + 10}" y2="${legendY + 5}" stroke="${color}" stroke-width="2"/>`;

      svg += `<text x="${x + 15}" y="${legendY + 9}" font-family="Arial" font-size="12">${escapeHtml(dataset.name)}</text>`;

    });

  }

  

  return svg;

}

// å††ã‚°ãƒ©ãƒ•/ãƒ‰ãƒ¼ãƒŠãƒ„ã‚°ãƒ©ãƒ•ã®SVGç”Ÿæˆ

function generatePieChartSvg(chartData, width, height, padding, showLegend, isDoughnut) {

  if (!chartData || chartData.length === 0 || !chartData[0].values) return '';

  

  const dataset = chartData[0]; // å††ã‚°ãƒ©ãƒ•ã¯æœ€åˆã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ã¿ä½¿ç”¨

  const values = dataset.values || [];

  const labels = dataset.labels || [];

  

  const centerX = width / 2;

  const centerY = height / 2 - 10;

  const radius = Math.min(width, height) / 2 - padding - 20;

  const innerRadius = isDoughnut ? radius * 0.6 : 0;

  

  // è‰²ã®é…åˆ—

  const colors = ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#8E24AA', '#16A2D7', '#FB8C00', '#F06292', '#00ACC1', '#AB47BC'];

  

  // åˆè¨ˆå€¤ã‚’è¨ˆç®—

  const total = values.reduce((sum, value) => sum + value, 0);

  

  let svg = '';

  

  // å††ã‚°ãƒ©ãƒ•ã®æç”»

  let startAngle = 0;

  values.forEach((value, i) => {

    const percentage = value / total;

    const endAngle = startAngle + percentage * Math.PI * 2;

    

    // å††å¼§ã®ãƒ‘ã‚¹ã‚’è¨ˆç®—

    const x1 = centerX + radius * Math.cos(startAngle);

    const y1 = centerY + radius * Math.sin(startAngle);

    const x2 = centerX + radius * Math.cos(endAngle);

    const y2 = centerY + radius * Math.sin(endAngle);

    

    const largeArcFlag = percentage > 0.5 ? 1 : 0;

    

    // å¤–å´ã®å††å¼§

    let pathData = `M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2} Z`;

    

    // ãƒ‰ãƒ¼ãƒŠãƒ„ã‚°ãƒ©ãƒ•ã®å ´åˆã¯å†…å´ã®å††å¼§ã‚‚æç”»

    if (isDoughnut) {

      const ix1 = centerX + innerRadius * Math.cos(startAngle);

      const iy1 = centerY + innerRadius * Math.sin(startAngle);

      const ix2 = centerX + innerRadius * Math.cos(endAngle);

      const iy2 = centerY + innerRadius * Math.sin(endAngle);

      

      pathData = `M ${x1} ${y1} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2} ` +

                 `L ${ix2} ${iy2} A ${innerRadius} ${innerRadius} 0 ${largeArcFlag} 0 ${ix1} ${iy1} Z`;

    }

    

    const color = colors[i % colors.length];

    

    svg += `<path d="${pathData}" fill="${color}" stroke="#fff" stroke-width="1">`;

    svg += `<title>${labels[i] || ''}: ${value} (${Math.round(percentage * 100)}%)</title>`;

    svg += `</path>`;

    

    // ãƒ©ãƒ™ãƒ«ã®ä½ç½®ã‚’è¨ˆç®—ï¼ˆã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ä¸­å¤®ï¼‰

    const midAngle = startAngle + (endAngle - startAngle) / 2;

    const labelRadius = radius * 0.7;

    const labelX = centerX + labelRadius * Math.cos(midAngle);

    const labelY = centerY + labelRadius * Math.sin(midAngle);

    

    // ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆè¡¨ç¤º

    if (percentage > 0.05) { // å°ã•ã™ãã‚‹ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«ã¯ãƒ©ãƒ™ãƒ«ã‚’è¡¨ç¤ºã—ãªã„

      svg += `<text x="${labelX}" y="${labelY}" text-anchor="middle" font-family="Arial" font-size="12" fill="#fff" font-weight="bold">`;

      svg += `${Math.round(percentage * 100)}%`;

      svg += `</text>`;

    }

    

    startAngle = endAngle;

  });

  

  // å‡¡ä¾‹

  if (showLegend) {

    const legendY = height - 30;

    const legendItemWidth = width / Math.min(values.length, 4);

    const legendItemsPerRow = Math.min(values.length, 4);

    

    values.forEach((value, i) => {

      const row = Math.floor(i / legendItemsPerRow);

      const col = i % legendItemsPerRow;

      const x = padding + (col * legendItemWidth);

      const y = legendY - (row * 20);

      const color = colors[i % colors.length];

      const percentage = value / total;

      

      svg += `<rect x="${x}" y="${y}" width="10" height="10" fill="${color}"/>`;

      svg += `<text x="${x + 15}" y="${y + 9}" font-family="Arial" font-size="11">`;

      svg += `${escapeHtml(labels[i] || '')}: ${value} (${Math.round(percentage * 100)}%)`;

      svg += `</text>`;

    });

  }

  

  return svg;

}

// HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°

function escapeHtml(text) {

  if (!text) return '';

  return text

    .toString()

    .replace(/&/g, '&amp;')

    .replace(/</g, '&lt;')

    .replace(/>/g, '&gt;')

    .replace(/"/g, '&quot;')

    .replace(/'/g, '&#039;');

}

/* ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ³¨å…¥ */

function injectPreviewStyles() {

  const styleEl = document.createElement('style');

  styleEl.textContent = `

/* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‘ãƒãƒ«å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ« */

#pptx-preview-panel {

  position: fixed;

  top: 0;

  right: 0;

  width: 30%; /* å…¨å¹…ã‚’ä½¿ç”¨ */

  height: 100vh;

  background: #f5f5f5; /* èƒŒæ™¯è‰²ã‚’ãƒ©ã‚¤ãƒˆã‚°ãƒ¬ãƒ¼ã«å¤‰æ›´ */

  box-shadow: -2px 0 10px rgba(0,0,0,0.2);

  z-index: 9999;

  display: flex;

  flex-direction: column;

  overflow: hidden;

}

.pp-header {

  display: flex;

  align-items: center;

  padding: 10px 15px;

  background: #e0e0e0; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®èƒŒæ™¯è‰²ã‚’å°‘ã—æ¿ƒã„ã‚°ãƒ¬ãƒ¼ã« */

  border-bottom: 1px solid #ccc;

}

.pp-header h3 {

  margin: 0;

  flex-grow: 1;

  font-size: 16px;

  color: #333; /* ãƒ†ã‚­ã‚¹ãƒˆè‰²ã‚’å°‘ã—æš—ã */

}

.pp-header button {

  background: none;

  border: none;

  cursor: pointer;

  font-size: 16px;

  margin-left: 10px;

}

.pp-button-container {

  display: flex;

  gap: 10px;

}

/* ã‚¹ãƒ©ã‚¤ãƒ‰ä¸€è¦§ã‚¨ãƒªã‚¢ */

.pp-slides {

  flex-grow: 1;

  overflow-y: auto;

  padding: 15px;

  display: flex;

  flex-direction: column;

  align-items: center; /* ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ä¸­å¤®ã«é…ç½® */

  background: #e8e8e8; /* ã‚¹ãƒ©ã‚¤ãƒ‰ä¸€è¦§ã‚¨ãƒªã‚¢ã®èƒŒæ™¯è‰²ã‚’ã‚°ãƒ¬ãƒ¼ã« */

}

/* ã‚¹ãƒ©ã‚¤ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠ */

.slide-container {

  width: 384px;  /* 1280px Ã— 0.3 = 384px */

  height: 216px; /* 720px Ã— 0.3 = 216px */

  margin-bottom: 20px; /* ã‚¹ãƒ©ã‚¤ãƒ‰é–“ã®éš™é–“ã‚’åºƒã’ã‚‹ */

  position: relative;

  overflow: hidden;

  box-shadow: 0 4px 8px rgba(0,0,0,0.15); /* ã‚·ãƒ£ãƒ‰ã‚¦ã‚’å¼·èª¿ */

  border-radius: 5px;

  background: #d0d0d0; /* ã‚³ãƒ³ãƒ†ãƒŠèƒŒæ™¯ã‚’ã‚°ãƒ¬ãƒ¼ã« */

  padding: 10px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¿½åŠ  */

}

/* ã‚¹ãƒ©ã‚¤ãƒ‰åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */

.slide-preview {

  background: white;

  border: 1px solid #ccc;

  border-radius: 3px;

  box-shadow: 0 2px 5px rgba(0,0,0,0.1);

  position: absolute; /* é‡è¦: absoluteã«å¤‰æ›´ */

  top: 10px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã«åˆã‚ã›ã¦èª¿æ•´ */

  left: 10px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã«åˆã‚ã›ã¦èª¿æ•´ */

  width: 1280px;

  height: 720px;

  transform-origin: top left; /* é‡è¦: top leftã«å¤‰æ›´ */

  transform: scale(0.28); /* ã‚¹ã‚±ãƒ¼ãƒ«ã‚’å°‘ã—å°ã•ã */

  margin-bottom: 0; /* é‡è¦: ãƒãƒ¼ã‚¸ãƒ³ã‚’å‰Šé™¤ */

  overflow: hidden;

}

/* æ›´æ–°é€šçŸ¥ã®ã‚¹ã‚¿ã‚¤ãƒ« */

.update-notification {

  position: fixed;

  bottom: 25px;

  right: 25px;

  padding: 12px 18px;

  border-radius: 5px;

  box-shadow: 0 3px 12px rgba(0, 0, 0, 0.2);

  z-index: 9999;

  font-size: 16px;

  transform: translateY(100px);

  opacity: 0;

  transition: transform 0.3s ease, opacity 0.3s ease;

}

.update-notification.show {

  transform: translateY(0);

  opacity: 1;

}

.update-notification.success {

  background: rgba(16, 124, 16, 0.9);

  color: white;

}

.update-notification.error {

  background: rgba(232, 17, 35, 0.9);

  color: white;

}

.pp-slides {

  flex-grow: 1;

  overflow-y: auto;

  padding: 15px;

  display: flex;

  flex-direction: column;

  align-items: center; /* ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ä¸­å¤®ã«é…ç½® */

}

/* ãƒšãƒ¼ã‚¸ã‚’å·¦ã«è©°ã‚ã‚‹ - ç„¡åŠ¹åŒ– */

body.pptx-preview-active {

  margin-right: 30%; /* å³å´30%ã‚’ç©ºã‘ã‚‹ */

  overflow: hidden; /* æœ¬æ–‡ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²æ­¢ */

  transition: margin-right 0.3s ease;

}

/* ã‚¹ãƒ©ã‚¤ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠ */

.slide-container {

  width: 384px;  /* 1280px Ã— 0.3 = 384px */

  height: 216px; /* 720px Ã— 0.3 = 216px */

  margin-bottom: 10px; /* ã‚¹ãƒ©ã‚¤ãƒ‰é–“ã®éš™é–“ã‚’é©åˆ‡ã«è¨­å®š */

  position: relative;

  overflow: hidden;

}

/* ã‚¹ãƒ©ã‚¤ãƒ‰åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */

.slide-preview {

  background: white;

  border: 1px solid #ddd;

  border-radius: 5px;

  box-shadow: 0 2px 5px rgba(0,0,0,0.1);

  position: absolute; /* é‡è¦: absoluteã«å¤‰æ›´ */

  top: 0;

  left: 0;

  width: 1280px;

  height: 720px;

  transform-origin: top left; /* é‡è¦: top leftã«å¤‰æ›´ */

  transform: scale(0.3);

  margin-bottom: 0; /* é‡è¦: ãƒãƒ¼ã‚¸ãƒ³ã‚’å‰Šé™¤ */

  overflow: hidden;

}

.slide-content {

  position: absolute;

  top: 0;

  left: 0;

  width: 100%;

  height: 100%;

  padding: 40px;

  box-sizing: border-box;

}

/* ã‚¹ãƒ©ã‚¤ãƒ‰å…±é€šè¦ç´  */

.slide-number {

  position: absolute;

  bottom: 20px;

  right: 30px;

  color: #000000;

  font-size: 24px;

  font-weight: bold;

  z-index: 10;

}

/* ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ†ã‚­ã‚¹ãƒˆè¦ç´  */

.slide-title {

  font-size: 60px;

  font-weight: bold;

  margin-bottom: 35px;

  color: #333;

  width: 90%;

}

.slide-heading {

  font-size: 48px;

  background: #DDDDDD;

  padding: 18px;

  margin-bottom: 35px;

  border-radius: 6px;

  color: #000000;

  width: 90%;

  box-sizing: border-box;

  display: inline-block;

}

.slide-body {

  font-size: 36px;

  line-height: 1.5;

  color: #555;

  width: 90%;

}

/* ã‚¢ã‚¸ã‚§ãƒ³ãƒ€ã‚¹ã‚¿ã‚¤ãƒ« */

.agenda-items {

  list-style-type: none;

  padding: 0;

  margin-top: 30px;

  width: 90%;

}

.agenda-items li {

  font-size: 24px;

  margin-bottom: 5px;

  color: #333;

  padding-left: 18px;

}

/* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */

.table-container {

  overflow-x: auto;

  margin-top: 18px;

  width: 90%;

}

.preview-table {

  width: 100%;

  border-collapse: collapse;

  margin-top: 18px;

  font-size: 24px;

}

.preview-table th {

  background: #404040;

  color: white;

  padding: 18px;

  text-align: center;

  font-weight: bold;

  font-size: 24px;

}

.preview-table td {

  padding: 18px;

  border: 2px solid #BFBFBF;

  text-align: center;

  font-size: 24px;

}

/* ãƒãƒ£ãƒ¼ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */

.chart-container {

  display: flex;

  justify-content: center;

  align-items: center;

  margin-top: 35px;

  overflow: hidden;

  height: 70%;

  width: 90%;

}

.chart-container svg {

  max-width: 100%;

  height: auto;

}

/* ã‚¹ã‚±ãƒ«ãƒˆãƒ³ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¿ã‚¤ãƒ« */

.skeleton {

  background: rgb(215, 215, 215);

  position: relative;

  overflow: hidden;

}

.skeleton::after {

  content: "";

  position: absolute;

  top: 0;

  right: 0;

  bottom: 0;

  left: 0;

  transform: translateX(-100%);

  background-image: linear-gradient(

    90deg,

    rgba(255, 255, 255, 0) 0,

    rgba(255, 255, 255, 0.2) 20%,

    rgba(255, 255, 255, 0.5) 60%,

    rgba(255, 255, 255, 0)

  );

  animation: shimmer 2s infinite;

}

@keyframes shimmer {

  100% {

    transform: translateX(100%);

  }

}

/* ã‚¹ã‚±ãƒ«ãƒˆãƒ³è¦ç´ ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ */

.skeleton-text {

  height: 36px;

  margin-bottom: 20px;

  border-radius: 6px;

  width: 90%;

}

.skeleton-title {

  height: 60px;

  width: 70%;

  margin-bottom: 35px;

  border-radius: 6px;

}

.skeleton-heading {

  height: 48px;

  width: 90%;

  margin-bottom: 35px;

  border-radius: 6px;

}

.skeleton-body {

  height: 200px;

  border-radius: 6px;

  width: 90%;

}

.skeleton-agenda-item {

  height: 42px;

  margin-bottom: 30px;

  border-radius: 6px;

  width: 90%;

}

.skeleton-table {

  height: 350px;

  border-radius: 6px;

  width: 90%;

}

.skeleton-chart {

  height: 350px;

  border-radius: 6px;

  width: 90%;

}

/* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºåˆ¶å¾¡ */

.hidden-content {

  opacity: 0;

  transition: opacity 0.3s ease;

}

.visible-content {

  opacity: 1;

  transition: opacity 0.3s ease;

}

/* ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¹ãƒ©ã‚¤ãƒ‰ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */

.schedule-container {

  width: 90%;

  margin-top: 70px;

}

.schedule-months {

  display: flex;

  background-color: #787878;

  color: white;

  font-weight: bold;

  margin-bottom: 4px;

  font-size: 32px;

}

.month-cell {

  flex: 1;

  text-align: center;

  padding: 14px 8px;

  border: 2px solid white;

}

.schedule-weeks {

  display: flex;

  background-color: #262626;

  color: white;

  font-size: 18px;

  margin-bottom: 18px;

}

.week-cell {

  flex: 1;

  text-align: center;

  padding: 8px 4px;

  border: 2px solid white;

}

.schedule-body {

  display: flex;

}

.schedule-tasks {

  width: 220px;

  background-color: #F2F2F2;

  margin-right: 20px;

}

.task-item {

  padding: 14px;

  border-bottom: 2px solid white;

  font-size: 28px;

  color: rgb(0, 0, 0);

}

.task-categories {

  display: flex;

  flex-direction: column;

  gap: 20px;

  width: calc(100% - 240px);

}

.task-category {

  margin-bottom: 12px;

}

.task-category svg {

  width: 220px;

  height: 88px;

}

.skeleton-schedule {

  height: 350px;

  width: 90%;

  border-radius: 6px;

}

/* ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚¹ãƒ©ã‚¤ãƒ‰ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */

.milestone-container {

  display: flex;

  position: relative;

  margin-top: 35px;

  padding-left: 35px;

  min-height: 200px;

  width: 90%;

}

.milestone-line {

  position: absolute;

  left: 185px;

  top: 0;

  bottom: 0;

  width: 3px;

  background-color: #C00000;

}

.milestone-days {

  width: 100px;

  margin-right: 25px;

  text-align: right;

}

.milestone-day {

  font-size: 20px;

  font-weight: bold;

  color: #595959;

  margin-bottom: 40px;

  padding-top: 12px;

}

.milestone-markers {

  width: 50px;

  margin-right: 25px;

  text-align: center;

  position: relative;

  z-index: 2;

}

.milestone-marker {

  font-size: 34px;

  font-weight: bold;

  color: #C00000;

  margin-bottom: 40px;

}

.milestone-content {

  flex: 1;

  max-width: calc(100% - 200px);

}

.milestone-item {

  margin-bottom: 30px;

}

.milestone-name {

  font-size: 24px;

  font-weight: bold;

  color: #C00000;

  margin-bottom: 12px;

}

.milestone-description {

  font-size: 20px;

  color: #595959;

  line-height: 1.4;

}

.milestone-overview {

  font-size: 24px;

  font-weight: bold;

  color: #C00000;

  margin-bottom: 20px;

  width: 90%;

}

.skeleton-milestone {

  height: 400px;

  width: 90%;

  border-radius: 6px;

}

/* JSONæ¤œå‡ºé€šçŸ¥ã®ã‚¹ã‚¿ã‚¤ãƒ« */

.json-detected {

  position: fixed;

  bottom: 25px;

  right: 25px;

  background: rgba(0, 120, 212, 0.9);

  color: white;

  padding: 12px 18px;

  border-radius: 5px;

  box-shadow: 0 3px 12px rgba(0, 0, 0, 0.2);

  z-index: 9999;

  font-size: 16px;

  transform: translateY(100px);

  opacity: 0;

  transition: transform 0.3s ease, opacity 0.3s ease;

}

.json-detected.show {

  transform: translateY(0);

  opacity: 1;

}

/* ã‚¢ã‚¤ã‚³ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */

#pptx-refresh-btn, #pptx-download-btn {

  background: none;

  color: #333;

  padding: 8px;

  border-radius: 50%;

  font-size: 14px;

  width: 32px;

  height: 32px;

  display: flex;

  align-items: center;

  justify-content: center;

  transition: background-color 0.2s ease;

}

#pptx-download-btn {

  background: #0078d4;

  color: white;

}

#pptx-refresh-btn {

  background: #107C10;

  color: white;

}

#pptx-download-btn:hover {

  background: #106ebe;

}

#pptx-refresh-btn:hover {

  background: #0B5C0B;

}

/* è‡ªå‹•æ›´æ–°ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« - å…ƒã®ã¾ã¾ */

#pptx-auto-update-btn {

  background: #0078d4;

  color: white;

  padding: 5px 10px;

  border-radius: 3px;

  font-size: 14px;

}

.auto-update-on {

  background: #107C10 !important;

}

.auto-update-off {

  background: #d83b01 !important;

}

#pptx-auto-update-btn:hover {

  opacity: 0.9;

}

.pp-close-btn {

  background: none;

  border: none;

  color: #333;

  font-size: 20px;

  cursor: pointer;

  width: 32px;

  height: 32px;

  display: flex;

  align-items: center;

  justify-content: center;

  border-radius: 50%;

  transition: background-color 0.2s ease;

}

.pp-close-btn:hover {

  background: rgba(0, 0, 0, 0.1);

}

`;

  document.head.appendChild(styleEl);

}

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒ©ã‚¤ãƒ‰ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’ç”Ÿæˆ

function generateDefaultSlidePreview(data, index) {

  const title = data.title || '';

  const heading = data.heading || '';

  const body = Array.isArray(data.body) ? data.body.join('<br><br>') : (data.body || '');

  const items = Array.isArray(data.items) ? data.items.join('<br><br>') : (data.items || '');

  const bodyText = body || items;

  

  return `

    <div class="slide-preview" data-index="${index}">

      <div class="slide-content default-slide">

        <!-- ã‚¹ã‚±ãƒ«ãƒˆãƒ³ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ -->

        <div class="skeleton-title skeleton"></div>

        ${heading ? `<div class="skeleton-heading skeleton"></div>` : ''}

        ${bodyText ? `<div class="skeleton-body skeleton"></div>` : ''}

        

        <!-- å®Ÿéš›ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆæœ€åˆã¯éè¡¨ç¤ºï¼‰ -->

        <div class="real-content hidden-content">

          <div class="slide-title">${escapeHtml(title)}</div>

          ${heading ? `<div class="slide-heading">${escapeHtml(heading)}</div>` : ''}

          ${bodyText ? `<div class="slide-body">${escapeHtml(bodyText)}</div>` : ''}

        </div>

        

  

        <div class="slide-number">${index + 1}</div>

      </div>

    </div>

  `;

}

// ã‚¢ã‚¸ã‚§ãƒ³ãƒ€ã‚¹ãƒ©ã‚¤ãƒ‰ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’ç”Ÿæˆ

function generateAgendaSlidePreview(data, index) {

  const title = data.title || '';

  const items = Array.isArray(data.body) ? data.body : (data.items || []);

  

  let itemsHtml = '';

  let skeletonItemsHtml = '';

  

  if (items.length > 0) {

    itemsHtml = '<ul class="agenda-items">';

    items.forEach((item, i) => {

      itemsHtml += `<li>${i + 1}. ${escapeHtml(item)}</li>`;

    });

    itemsHtml += '</ul>';

    

    // ã‚¹ã‚±ãƒ«ãƒˆãƒ³ã‚¢ã‚¸ã‚§ãƒ³ãƒ€é …ç›®

    skeletonItemsHtml = '';

    items.forEach(() => {

      skeletonItemsHtml += `<div class="skeleton-agenda-item skeleton"></div>`;

    });

  }

  

  return `

    <div class="slide-preview" data-index="${index}">

      <div class="slide-content agenda-slide">

        <!-- ã‚¹ã‚±ãƒ«ãƒˆãƒ³ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ -->

        <div class="skeleton-title skeleton"></div>

        ${skeletonItemsHtml}

        

        <!-- å®Ÿéš›ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆæœ€åˆã¯éè¡¨ç¤ºï¼‰ -->

        <div class="real-content hidden-content">

          <div class="slide-title">${escapeHtml(title)}</div>

          ${itemsHtml}

        </div>

        

        <div class="slide-number">${index + 1}</div>

      </div>

    </div>

  `;

}

// ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ãƒ©ã‚¤ãƒ‰ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’ç”Ÿæˆ

function generateTableSlidePreview(data, index) {

  const title = data.title || '';

  const heading = data.heading || '';

  const tableData = data.tableData || [];

  

  let tableHtml = '';

  if (tableData.length > 0) {

    tableHtml = '<table class="preview-table">';

    

    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ

    tableHtml += '<tr class="table-header">';

    if (tableData[0] && Array.isArray(tableData[0])) {

      tableData[0].forEach(cell => {

        tableHtml += `<th>${escapeHtml(cell)}</th>`;

      });

    }

    tableHtml += '</tr>';

    

    // ãƒ‡ãƒ¼ã‚¿è¡Œ

    for (let i = 1; i < tableData.length; i++) {

      tableHtml += '<tr>';

      if (Array.isArray(tableData[i])) {

        tableData[i].forEach(cell => {

          tableHtml += `<td>${escapeHtml(cell)}</td>`;

        });

      }

      tableHtml += '</tr>';

    }

    

    tableHtml += '</table>';

  }

  

  return `

    <div class="slide-preview" data-index="${index}">

      <div class="slide-content table-slide">

        <!-- ã‚¹ã‚±ãƒ«ãƒˆãƒ³ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ -->

        <div class="skeleton-title skeleton"></div>

        ${heading ? `<div class="skeleton-heading skeleton"></div>` : ''}

        <div class="skeleton-table skeleton"></div>

        

        <!-- å®Ÿéš›ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆæœ€åˆã¯éè¡¨ç¤ºï¼‰ -->

        <div class="real-content hidden-content">

          <div class="slide-title">${escapeHtml(title)}</div>

          ${heading ? `<div class="slide-heading">${escapeHtml(heading)}</div>` : ''}

          <div class="table-container">

            ${tableHtml}

          </div>

        </div>

        

      

        <div class="slide-number">${index + 1}</div>

      </div>

    </div>

  `;

}

// ãƒãƒ£ãƒ¼ãƒˆã‚¹ãƒ©ã‚¤ãƒ‰ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’ç”Ÿæˆ

function generateChartSlidePreview(data, index) {

  const title = data.title || '';

  const heading = data.heading || '';

  const chartTitle = data.chartTitle || '';

  const chartType = data.chartType || 'bar';

  const chartData = data.chartData || [];

  

  // ãƒãƒ£ãƒ¼ãƒˆã®SVGè¡¨ç¾ã‚’ç”Ÿæˆ

  let chartSvg = generateChartSvg(chartType, chartData, {

    title: chartTitle,

    showLegend: data.showLegend

  });

  

  return `

    <div class="slide-preview" data-index="${index}">

      <div class="slide-content chart-slide">

        <!-- ã‚¹ã‚±ãƒ«ãƒˆãƒ³ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ -->

        <div class="skeleton-title skeleton"></div>

        ${heading ? `<div class="skeleton-heading skeleton"></div>` : ''}

        <div class="skeleton-chart skeleton"></div>

        

        <!-- å®Ÿéš›ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆæœ€åˆã¯éè¡¨ç¤ºï¼‰ -->

        <div class="real-content hidden-content">

          <div class="slide-title">${escapeHtml(title)}</div>

          ${heading ? `<div class="slide-heading">${escapeHtml(heading)}</div>` : ''}

          <div class="chart-container">

            ${chartSvg}

          </div>

        </div>

        

        <div class="slide-number">${index + 1}</div>

      </div>

    </div>

  `;

}

// Blob ã‚’å—ã‘å–ã£ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãƒ¬ãƒ³ãƒ€ãƒ¼

function renderPreview(blob, jsonData) {

  console.log('renderPreview called with blob size:', blob.size);

  latestBlob = blob;

  

  try {

    // createPreviewPanel ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

    if (typeof createPreviewPanel !== 'function') {

      console.error('createPreviewPanel is not defined. Reloading content script...');

      // å¿…è¦ãªé–¢æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º

      alert("ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã«å¿…è¦ãªæ©Ÿèƒ½ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚");

      return;

    }

    

    const panel = createPreviewPanel();

    

    // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ³¨å…¥

    if (typeof injectPreviewStyles === 'function') {

      injectPreviewStyles();

    } else {

      console.warn('injectPreviewStyles is not defined, skipping style injection');

    }

    

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’ç”Ÿæˆ

    if (typeof generateSlidePreviewImages !== 'function') {

      console.error('generateSlidePreviewImages is not defined');

      alert("ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒç”Ÿæˆæ©Ÿèƒ½ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚");

      return;

    }

    

    const previewImages = generateSlidePreviewImages(jsonData);

    

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’è¡¨ç¤º

    const view = document.getElementById('pptx-preview-view');

    if (!view) {

      console.error('pptx-preview-view element not found');

      alert("ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºé ˜åŸŸãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚");

      return;

    }

    

    view.innerHTML = '';

    

    if (previewImages && previewImages.length > 0) {

      previewImages.forEach(html => {

        try {

          // ã‚¹ãƒ©ã‚¤ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ

          const container = document.createElement('div');

          container.className = 'slide-container';

          

          // ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ã‚³ãƒ³ãƒ†ãƒŠã«è¿½åŠ 

          const slideDiv = document.createElement('div');

          slideDiv.innerHTML = html;

          

          if (slideDiv.firstElementChild) {

            container.appendChild(slideDiv.firstElementChild);

            // ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ“ãƒ¥ãƒ¼ã«è¿½åŠ 

            view.appendChild(container);

          } else {

            console.warn('No slide content found in HTML:', html);

          }

        } catch (slideError) {

          console.error('Error creating slide:', slideError);

        }

      });

      

      // 1ç§’å¾Œã«ã‚¹ã‚±ãƒ«ãƒˆãƒ³ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚’å®Ÿéš›ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ç½®ãæ›ãˆã‚‹

      setTimeout(() => {

        try {

          const realContents = document.querySelectorAll('.real-content');

          realContents.forEach(content => {

            content.classList.remove('hidden-content');

            content.classList.add('visible-content');

          });

          

          // ã‚¹ã‚±ãƒ«ãƒˆãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹

          const skeletons = document.querySelectorAll('.skeleton');

          skeletons.forEach(skeleton => {

            skeleton.style.display = 'none';

          });

        } catch (animationError) {

          console.error('Error during animation transition:', animationError);

        }

      }, 1000);

    } else {

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒãŒãªã„å ´åˆã¯ä»£æ›¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º

      const message = document.createElement('div');

      message.style.padding = '20px';

      message.style.textAlign = 'center';

      message.innerHTML = `

        <p style="margin-bottom: 20px; color: #666;">ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã§ãã¾ã™ã€‚</p>

        <svg width="200" height="150" viewBox="0 0 200 150" xmlns="http://www.w3.org/2000/svg" style="margin-bottom: 20px;">

          <rect x="10" y="10" width="180" height="130" fill="#f5f5f5" stroke="#ccc" stroke-width="1"/>

          <text x="100" y="60" font-family="Arial" font-size="14" text-anchor="middle">ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ</text>

          <text x="100" y="85" font-family="Arial" font-size="12" text-anchor="middle">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã§ãã¾ã™</text>

          <path d="M70,110 L130,110 L100,130 Z" fill="#0078d4"/>

        </svg>

      `;

      view.appendChild(message);

    }

  } catch (error) {

    console.error('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', error);

    alert("ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚");

  }

}

 

// JSONãƒ‡ãƒ¼ã‚¿ã«ã‚°ãƒ©ãƒ•ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹æ¤œå‡ºã™ã‚‹é–¢æ•°

function containsChartData(jsonData) {

  try {

    const data = JSON.parse(jsonData);

    const slides = Array.isArray(data) ? data : [data];

    

    // ã„ãšã‚Œã‹ã®ã‚¹ãƒ©ã‚¤ãƒ‰ãŒãƒãƒ£ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯

    return slides.some(slide => 

      slide.slidetype === 'chart' || 

      slide.type === 'chart' || 

      (slide.chartData && Array.isArray(slide.chartData))

    );

  } catch (e) {

    console.error('JSONãƒ‡ãƒ¼ã‚¿ã®è§£æã‚¨ãƒ©ãƒ¼:', e);

    return false;

  }

}

 // ===== JSONæ¤œå‡ºé–¢é€£ã®é–¢æ•° =====

 // ãƒšãƒ¼ã‚¸å†…ã®JSONã‚’æ¤œå‡ºã—ã¦é€šçŸ¥

function detectJsonInPage() {

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‘ãƒãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„

  const previewPanel = document.getElementById('pptx-preview-panel');

  if (!previewPanel) {

    return false;

  }

  

  // ãƒšãƒ¼ã‚¸å†…ã®ã™ã¹ã¦ã®JSONã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’æ¢ã™

  const codeBlocks = document.querySelectorAll('code.language-json, pre');

  

  // æœ‰åŠ¹ãªJSONã‚’å«ã‚€ãƒ–ãƒ­ãƒƒã‚¯ã‚’åé›†

  const validJsonBlocks = [];

  for (const block of codeBlocks) {

    try {

      const text = block.innerText || block.textContent;

      // JSONã¨ã—ã¦è§£æã§ãã‚‹ã‹ç¢ºèª

      JSON.parse(text);

      validJsonBlocks.push(block);

    } catch (e) {

      // JSONã¨ã—ã¦è§£æã§ããªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—

      continue;

    }

  }

  

  if (validJsonBlocks.length === 0) {

    return false; // æœ‰åŠ¹ãªJSONãŒè¦‹ã¤ã‹ã‚‰ãªã„

  }

  

  // è¤‡æ•°ã®JSONãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã¯ã€ãã®æ•°ã‚’é€šçŸ¥ã«å«ã‚ã‚‹

  const jsonCount = validJsonBlocks.length;

  

  // é€šçŸ¥ã‚’è¡¨ç¤º

  showJsonDetectedNotification(jsonCount);

  

  // æœ€å¾Œã®JSONãƒ–ãƒ­ãƒƒã‚¯ã‚’è»½ãå¼·èª¿è¡¨ç¤º

  const latestBlock = validJsonBlocks[validJsonBlocks.length - 1];

  latestBlock.style.border = '2px dashed #0078d4';

  latestBlock.style.padding = '8px';

  latestBlock.style.transition = 'all 0.3s ease';

  

  return true;

}

 

 // JSONæ¤œå‡ºé€šçŸ¥ã‚’è¡¨ç¤º

 function showJsonDetectedNotification(count) {

   // ã™ã§ã«é€šçŸ¥ãŒã‚ã‚Œã°ä½•ã‚‚ã—ãªã„

   if (document.querySelector('.json-detected')) return;

   

   const notification = document.createElement('div');

   notification.className = 'json-detected';

   

   if (count > 1) {

     notification.textContent = `${count}å€‹ã®JSONãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚ä¸€ç•ªä¸‹ã®JSONãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚`;

   } else {

     notification.textContent = 'JSONãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚æ‹¡å¼µæ©Ÿèƒ½ã§ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆã§ãã¾ã™ã€‚';

   }

   

   document.body.appendChild(notification);

   

   // è¡¨ç¤ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³

   setTimeout(() => notification.classList.add('show'), 100);

   

   // 5ç§’å¾Œã«æ¶ˆãˆã‚‹

   setTimeout(() => {

     notification.classList.remove('show');

     setTimeout(() => notification.remove(), 300);

   }, 5000);

 }

 // ãƒšãƒ¼ã‚¸ã‹ã‚‰JSONãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•°

function getJsonFromPage() {

  // ãƒšãƒ¼ã‚¸å†…ã®ã™ã¹ã¦ã®JSONã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’æ¢ã™

  const codeBlocks = document.querySelectorAll('code.language-json, pre');

  

  // æœ‰åŠ¹ãªJSONã‚’å«ã‚€ãƒ–ãƒ­ãƒƒã‚¯ã‚’åé›†

  const validJsonBlocks = [];

  for (const block of codeBlocks) {

    try {

      const text = block.innerText || block.textContent;

      // JSONã¨ã—ã¦è§£æã§ãã‚‹ã‹ç¢ºèª

      JSON.parse(text);

      // æœ‰åŠ¹ãªJSONãƒ–ãƒ­ãƒƒã‚¯ã¨ãã®ä½ç½®æƒ…å ±ã‚’ä¿å­˜

      const rect = block.getBoundingClientRect();

      validJsonBlocks.push({

        text: text,

        position: rect.top + window.scrollY, // ãƒšãƒ¼ã‚¸ä¸Šã®çµ¶å¯¾ä½ç½®

        element: block

      });

    } catch (e) {

      // JSONã¨ã—ã¦è§£æã§ããªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—

      continue;

    }

  }

  

  if (validJsonBlocks.length === 0) {

    return null; // æœ‰åŠ¹ãªJSONãŒè¦‹ã¤ã‹ã‚‰ãªã„

  }

  

  // ä½ç½®æƒ…å ±ã§ã‚½ãƒ¼ãƒˆï¼ˆä¸‹ã«ã‚ã‚‹ã‚‚ã®ãŒå¾Œã‚ã«æ¥ã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰

  validJsonBlocks.sort((a, b) => a.position - b.position);

  

  // æœ€å¾Œï¼ˆä¸€ç•ªä¸‹ï¼‰ã®JSONãƒ–ãƒ­ãƒƒã‚¯ã‚’å–å¾—

  const latestBlock = validJsonBlocks[validJsonBlocks.length - 1];

  

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‘ãƒãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å¼·èª¿è¡¨ç¤º

  const previewPanel = document.getElementById('pptx-preview-panel');

  if (previewPanel) {

    // é¸æŠã•ã‚ŒãŸJSONãƒ–ãƒ­ãƒƒã‚¯ã‚’è¦–è¦šçš„ã«å¼·èª¿è¡¨ç¤º

    for (const block of validJsonBlocks) {

      if (block.element === latestBlock.element) {

        // é¸æŠã•ã‚ŒãŸãƒ–ãƒ­ãƒƒã‚¯ã‚’å¼·èª¿è¡¨ç¤º

        block.element.style.border = '3px solid #4CAF50';

        block.element.style.boxShadow = '0 0 10px rgba(76, 175, 80, 0.7)';

        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãªã„

      } else {

        // ä»–ã®JSONãƒ–ãƒ­ãƒƒã‚¯ã¯è–„ã„å¼·èª¿è¡¨ç¤º

        block.element.style.border = '1px solid #0078d4';

        block.element.style.boxShadow = '0 0 5px rgba(0, 120, 212, 0.3)';

      }

    }

  }

  

  // æœ€æ–°ã®JSONãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™

  return latestBlock.text;

}

 

 // ===== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç† =====

 // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡

 chrome.runtime.onMessage.addListener((msg, sender, sendResponse) => {

   console.log('Content script received message:', msg);

   

   // æ¥ç¶šç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

   if (msg.action === 'ping') {

     console.log('Ping received');

     sendResponse({ status: 'ok' });

     return true;

   }

   

   // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºãƒªã‚¯ã‚¨ã‚¹ãƒˆ

   if (msg.action === 'renderPreview' && msg.pptxB64 && msg.jsonData) {

     console.log('Render preview request received');

     // Base64â†’Uint8Array

     const bin = atob(msg.pptxB64);

     const len = bin.length;

     const buf = new Uint8Array(len);

     for (let i = 0; i < len; i++) buf[i] = bin.charCodeAt(i);

     

     const blob = new Blob([buf.buffer], {

       type: 'application/vnd.openxmlformats-officedocument.presentationml.presentation'

     });

     

     renderPreview(blob, msg.jsonData);

     sendResponse({ status: 'ok' });

     return true;

   }

   

   // å¾“æ¥ã®æ–¹æ³•ï¼ˆäº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰

   if (msg.pptxB64) {

     console.log('Legacy preview request received');

     // Base64â†’Uint8Array

     const bin = atob(msg.pptxB64);

     const len = bin.length;

     const buf = new Uint8Array(len);

     for (let i = 0; i < len; i++) buf[i] = bin.charCodeAt(i);

     

     const blob = new Blob([buf.buffer], {

       type: 'application/vnd.openxmlformats-officedocument.presentationml.presentation'

     });

     

     // JSONãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ç©ºã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º

     renderPreview(blob, '[]');

     return true;

   }

 });

// ===== ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³é–¢é€£ =====

// ãƒ‘ãƒãƒ«ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’è¿½è·¡ã™ã‚‹å¤‰æ•°

let isPanelVisible = false;

// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 

function injectToggleButton() {

  try {

    // ã™ã§ã«ã‚ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—

    if (document.getElementById('pptx-preview-toggle')) return;

    

    // å¿…è¦ãªä¾å­˜é–¢æ•°ã¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª

    const dependenciesExist = 

      typeof getJsonFromPage === 'function' && 

      typeof renderPreview === 'function' && 

      typeof SlideCreator !== 'undefined' && 

      typeof PptxGenJS !== 'undefined';

    

    // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ 

    const style = document.createElement('style');

    style.textContent = `

      #pptx-preview-toggle {

        position: fixed;

        right: 0;

        top: 80%;

        transform: translateY(-80%);

        z-index: 9998;

        background: #0078d4;

        color: white;

        border: none;

        border-top-left-radius: 5px;

        border-bottom-left-radius: 5px;

        border-top-right-radius: 0;

        border-bottom-right-radius: 0;

        padding: 8px 8px;

        font-size: 14px;

        cursor: pointer;

        box-shadow: -2px 0 8px rgba(0, 0, 0, 0.2);

        transition: all 0.3s ease;

        display: flex;

        flex-direction: column;

        align-items: center;

        justify-content: center;

      }

      

      /* ãƒ‘ãƒãƒ«ãŒé–‹ã„ã¦ã„ã‚‹ã¨ãã®ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */

      #pptx-preview-toggle.panel-open {

        right: 30%; /* ãƒ‘ãƒãƒ«ã®å¹…ã¨åŒã˜ã ã‘å³ã«ç§»å‹• */

      }

      

      #pptx-preview-toggle:hover {

        background: #106ebe;

        transform: translateY(-80%) translateX(-5px);

      }

      

      #pptx-preview-toggle.panel-open:hover {

        transform: translateY(-80%) translateX(-5px);

      }

      

      #pptx-preview-toggle img {

        width: 16px;

        height: auto;

        margin-top: 5px;

        transition: transform 0.3s ease;

      }

      

      #pptx-preview-toggle:hover img {

        transform: scale(1.1);

      }

      

      /* ãƒ‘ãƒãƒ«ãŒé–‹ã„ã¦ã„ã‚‹ã¨ãã®çŸ¢å°ã®å‘ã */

      #pptx-preview-toggle.panel-open img {

        transform: rotate(180deg);

      }

      

      #pptx-preview-toggle.panel-open:hover img {

        transform: rotate(180deg) scale(1.1);

      }

      

      #pptx-preview-toggle .text {

        writing-mode: vertical-rl;

        text-orientation: mixed;

        margin-bottom: 8px;

        line-height: 1.2;

      }

    `;

    document.head.appendChild(style);

    

    // ãƒœã‚¿ãƒ³ã‚’ä½œæˆ

    const btn = document.createElement('button');

    btn.id = 'pptx-preview-toggle';

    

    // ç”»åƒã®URLã‚’å–å¾—

    const arrowImgUrl = chrome.runtime.getURL('images/Arrow.png');

    

    // ãƒœã‚¿ãƒ³å†…ã«ãƒ†ã‚­ã‚¹ãƒˆã¨ç”»åƒã‚’ç¸¦ã«é…ç½®

    btn.innerHTML = `

      <span class="text">PPT Gen</span>

      <img src="${arrowImgUrl}" alt="çŸ¢å°">

    `;

    

    // ãƒšãƒ¼ã‚¸ã«ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 

    if (document.body) {

      document.body.appendChild(btn);

    } else {

      console.error('document.body is not available yet');

      return;

    }

    

    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ - ãƒˆã‚°ãƒ«å‹•ä½œã«å¤‰æ›´

    btn.addEventListener('click', async () => {

      try {

        // æ—¢å­˜ã®ãƒ‘ãƒãƒ«ã‚’ãƒã‚§ãƒƒã‚¯

        const existingPanel = document.getElementById('pptx-preview-panel');

        

        if (existingPanel) {

          // ãƒ‘ãƒãƒ«ãŒæ—¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯é–‰ã˜ã‚‹

          existingPanel.remove();

          document.body.classList.remove('pptx-preview-active');

          btn.classList.remove('panel-open');

          isPanelVisible = false;

          stopJsonAutoDetection(); // ç›£è¦–ã‚’åœæ­¢

          return;

        }

        

        // ä¾å­˜é–¢ä¿‚ã®ãƒã‚§ãƒƒã‚¯

        if (!dependenciesExist) {

          console.error('å¿…è¦ãªä¾å­˜é–¢ä¿‚ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');

          alert("å¿…è¦ãªæ©Ÿèƒ½ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚");

          return;

        }

        

        // ãƒšãƒ¼ã‚¸ã‹ã‚‰JSONãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—

        const jsonData = getJsonFromPage();

        if (jsonData) {

          // JSONãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã€ãã‚Œã‚’ä½¿ç”¨

          console.log('ğŸ“„ [content.js] ãƒšãƒ¼ã‚¸ã‹ã‚‰JSONãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—:', jsonData);

          try {

            // PPTXç”Ÿæˆ

            const pptx = new PptxGenJS();

            if (!pptx) {

              throw new Error("PptxGenJSã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ");

            }

            pptx.defineLayout({ 

              name: 'myLayout', 

              width: SlideCreator.LAYOUT_WIDTH, 

              height: SlideCreator.LAYOUT_HEIGHT 

            });

            pptx.layout = 'myLayout';

            

            // ãƒã‚¹ã‚¿ãƒ¼å®šç¾©

            // ãƒ­ã‚´ã®ãƒ‘ã‚¹ã‚’å–å¾—ï¼ˆæ‹¡å¼µæ©Ÿèƒ½å†…ã®ãƒªã‚½ãƒ¼ã‚¹ï¼‰

            const logoPath = chrome.runtime.getURL('logo.png');

            if (!SlideCreator.defineMasterSlide) {

              throw new Error("SlideCreator.defineMasterSlide is not a function");

            }

            const masterDefined = SlideCreator.defineMasterSlide(pptx, logoPath);

            if (!masterDefined) {

              console.warn("ãƒã‚¹ã‚¿ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ‰ã®å®šç¾©ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã§ç¶šè¡Œã—ã¾ã™ã€‚");

            }

            

            // JSONãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ç”Ÿæˆ

            if (!SlideCreator.createSlidesFromJson) {

              throw new Error("SlideCreator.createSlidesFromJson is not a function");

            }

            const success = SlideCreator.createSlidesFromJson(pptx, jsonData, false);

            if (!success) {

              // å¤±æ•—ã—ãŸå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ä½¿ç”¨

              console.warn("JSONãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã®ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚");

              if (!SlideCreator.getDefaultSlides) {

                throw new Error("SlideCreator.getDefaultSlides is not a function");

              }

              // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‡ãƒ¼ã‚¿

              const slideDataList = SlideCreator.getDefaultSlides();

              if (!Array.isArray(slideDataList) || slideDataList.length === 0) {

                throw new Error("ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");

              }

              // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’è¿½åŠ 

              slideDataList.forEach(data => {

                const slide = pptx.addSlide({ masterName: SlideCreator.MASTER_SLIDE_TITLE });

                SlideCreator.createSlideByType(slide, data, pptx, false);

              });

            }

            

            // Blob å–å¾—â†’ãƒ¬ãƒ³ãƒ€ãƒ¼

            if (!pptx.write) {

              throw new Error("pptx.write is not a function");

            }

            const blob = await pptx.write('blob');

            if (!blob || !(blob instanceof Blob)) {

              throw new Error("Blobã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ");

            }

            

            // ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º

            renderPreview(blob, jsonData);

            

            // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°

            btn.classList.add('panel-open');

            isPanelVisible = true;

            

          } catch (pptxError) {

            console.error('[content.js] PPTXç”Ÿæˆã‚¨ãƒ©ãƒ¼:', pptxError);

            alert(`PPTXç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${pptxError.message}`);

          }

        } else {

          // JSONãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ä½¿ç”¨

          console.log("ãƒšãƒ¼ã‚¸ã‹ã‚‰JSONãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚");

          try {

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‡ãƒ¼ã‚¿

            if (!SlideCreator.getDefaultSlides) {

              throw new Error("SlideCreator.getDefaultSlides is not a function");

            }

            const slideDataList = SlideCreator.getDefaultSlides();

            const defaultJson = JSON.stringify(slideDataList);

            // PPTXç”Ÿæˆ

            const pptx = new PptxGenJS();

            pptx.defineLayout({ 

              name: 'myLayout', 

              width: SlideCreator.LAYOUT_WIDTH, 

              height: SlideCreator.LAYOUT_HEIGHT 

            });

            pptx.layout = 'myLayout';

            // ãƒã‚¹ã‚¿ãƒ¼å®šç¾©

            const logoPath = chrome.runtime.getURL('logo.png');

            SlideCreator.defineMasterSlide(pptx, logoPath);

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’è¿½åŠ 

            slideDataList.forEach(data => {

              const slide = pptx.addSlide({ masterName: SlideCreator.MASTER_SLIDE_TITLE });

              SlideCreator.createSlideByType(slide, data, pptx, false);

            });

            // Blob å–å¾—â†’ãƒ¬ãƒ³ãƒ€ãƒ¼

            const blob = await pptx.write('blob');

            

            // ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º

            renderPreview(blob, defaultJson);

            

            // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°

            btn.classList.add('panel-open');

            isPanelVisible = true;

          } catch (defaultError) {

            console.error('[content.js] ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', defaultError);

            alert(`ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${defaultError.message}`);

          }

        }

      } catch (error) {

        console.error('[content.js] ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);

        alert(`ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}\nãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚`);

      }

    });

  } catch (buttonError) {

    console.error('[content.js] ãƒœã‚¿ãƒ³ä½œæˆã‚¨ãƒ©ãƒ¼:', buttonError);

  }

}

// ===== åˆæœŸåŒ–å‡¦ç† =====

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«å®Ÿè¡Œ

window.addEventListener('load', () => {

  console.log('Content script loaded');

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 

  injectToggleButton();

  

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‘ãƒãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿JSONæ¤œå‡ºã‚’è¡Œã†

  const previewPanel = document.getElementById('pptx-preview-panel');

  if (previewPanel) {

    detectJsonInPage();

    startJsonAutoDetection();

  }

});

// åˆæœŸåŒ–æ™‚ã«ã‚‚ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ï¼ˆDOMContentLoadedã‚ˆã‚Šæ—©ãå®Ÿè¡Œã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ï¼‰

injectToggleButton();

// ä¸€å®šæ™‚é–“å¾Œã«ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã®å­˜åœ¨ã‚’ç¢ºèªï¼ˆéåŒæœŸèª­ã¿è¾¼ã¿ãƒšãƒ¼ã‚¸å¯¾å¿œï¼‰

setTimeout(() => {

  if (!document.getElementById('pptx-preview-toggle')) {

    injectToggleButton();

  }

}, 2000);

